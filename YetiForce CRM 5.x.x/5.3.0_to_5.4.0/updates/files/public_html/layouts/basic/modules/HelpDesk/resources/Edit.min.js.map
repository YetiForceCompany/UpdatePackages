{"version":3,"file":"Edit.min.js","sources":["Edit.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nVtiger_Edit_Js(\n\t'HelpDesk_Edit_Js',\n\t{},\n\t{\n\t\t/**\n\t\t * Register pre save event\n\t\t * @param {jQuery} form\n\t\t */\n\t\tregisterRecordPreSaveEventEvent: function (form) {\n\t\t\tthis._super(form);\n\t\t\tconst self = this;\n\t\t\tlet lockSave = true;\n\t\t\tform.on(Vtiger_Edit_Js.recordPreSave, function (e, data) {\n\t\t\t\tlet closedStatus = JSON.parse(app.getMainParams('closeTicketForStatus'));\n\t\t\t\tlet status = form.find('[name=\"ticketstatus\"] :selected').val();\n\t\t\t\tlet progress = $.progressIndicator({ position: 'html', blockInfo: { enabled: true } });\n\t\t\t\tlet isClosedStatusSet = status in closedStatus;\n\t\t\t\tconst recordId = app.getRecordId();\n\t\t\t\tif (\n\t\t\t\t\t(app.getMainParams('checkIfRecordHasTimeControl') ||\n\t\t\t\t\t\tapp.getMainParams('checkIfRelatedTicketsAreClosed')) &&\n\t\t\t\t\tisClosedStatusSet &&\n\t\t\t\t\trecordId &&\n\t\t\t\t\t!data.module\n\t\t\t\t) {\n\t\t\t\t\tif (lockSave && recordId) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\tAppConnector.request({\n\t\t\t\t\t\t\taction: 'CheckValidateToClose',\n\t\t\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\t\t\trecord: recordId,\n\t\t\t\t\t\t\tstatus: form.find('[name=\"ticketstatus\"] :selected').val()\n\t\t\t\t\t\t}).done((response) => {\n\t\t\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\tresponse.result.hasTimeControl.result &&\n\t\t\t\t\t\t\t\tresponse.result.relatedTicketsClosed.result\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\tlockSave = false;\n\t\t\t\t\t\t\t\tform.submit();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!response.result.hasTimeControl.result) {\n\t\t\t\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\t\t\t\ttext: response.result.hasTimeControl.message,\n\t\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tself.addTimeControl({\n\t\t\t\t\t\t\t\t\trecordId: recordId,\n\t\t\t\t\t\t\t\t\turl: `index.php?module=OSSTimeControl&view=Edit&sourceModule=HelpDesk&sourceRecord=${recordId}&relationOperation=true&subprocess=${recordId}&subprocess=${recordId}`\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (!response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\t\t\t\ttext: response.result.relatedTicketsClosed.message,\n\t\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (isClosedStatusSet && (!recordId || data.module)) {\n\t\t\t\t\tVtiger_Helper_Js.showPnotify({\n\t\t\t\t\t\ttext: app.vtranslate('JS_CANT_CLOSE_NEW_RECROD'),\n\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t});\n\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t/**\n\t\t * Add time control when closed ticket\n\t\t * @param {array} params\n\t\t */\n\t\taddTimeControl: function (params) {\n\t\t\tlet aDeferred = jQuery.Deferred();\n\t\t\tlet referenceModuleName = 'OSSTimeControl';\n\t\t\tlet parentId = params.recordId;\n\t\t\tlet parentModule = 'HelpDesk';\n\t\t\tlet quickCreateParams = {};\n\t\t\tlet relatedParams = {};\n\t\t\tlet relatedField = 'subprocess';\n\t\t\tlet fullFormUrl = params.url;\n\t\t\trelatedParams[relatedField] = parentId;\n\t\t\tlet eliminatedKeys = new Array('view', 'module', 'mode', 'action');\n\n\t\t\tlet preQuickCreateSave = function (data) {\n\t\t\t\tlet index, queryParam, queryParamComponents;\n\t\t\t\tlet queryParameters = [];\n\n\t\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\t\tqueryParameters = queryString.split('&');\n\t\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\t\tif (queryParamComponents[0] == 'mode' && queryParamComponents[1] == 'Calendar') {\n\t\t\t\t\t\t\tdata.find('a[data-tab-name=\"Task\"]').trigger('click');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceModule\" value=\"' + parentModule + '\" />').appendTo(\n\t\t\t\t\tdata\n\t\t\t\t);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceRecord\" value=\"' + parentId + '\" />').appendTo(\n\t\t\t\t\tdata\n\t\t\t\t);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"relationOperation\" value=\"true\" />').appendTo(data);\n\n\t\t\t\tif (typeof relatedField !== 'undefined') {\n\t\t\t\t\tlet field = data.find('[name=\"' + relatedField + '\"]');\n\t\t\t\t\tif (field.length == 0) {\n\t\t\t\t\t\tjQuery(\n\t\t\t\t\t\t\t'<input type=\"hidden\" name=\"' + relatedField + '\" value=\"' + parentId + '\" />'\n\t\t\t\t\t\t).appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (\n\t\t\t\t\t\tjQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1' &&\n\t\t\t\t\t\tdata.find('[name=\"' + queryParamComponents[0] + '\"]').length == 0\n\t\t\t\t\t) {\n\t\t\t\t\t\tjQuery(\n\t\t\t\t\t\t\t'<input type=\"hidden\" name=\"' +\n\t\t\t\t\t\t\t\tqueryParamComponents[0] +\n\t\t\t\t\t\t\t\t'\" value=\"' +\n\t\t\t\t\t\t\t\tqueryParamComponents[1] +\n\t\t\t\t\t\t\t\t'\" />'\n\t\t\t\t\t\t).appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\tlet queryParameters = queryString.split('&');\n\t\t\t\tfor (let index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tlet queryParam = queryParameters[index];\n\t\t\t\t\tlet queryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (jQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1') {\n\t\t\t\t\t\trelatedParams[queryParamComponents[0]] = queryParamComponents[1];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tquickCreateParams['data'] = relatedParams;\n\t\t\tquickCreateParams['callbackFunction'] = function () {};\n\t\t\tquickCreateParams['callbackPostShown'] = preQuickCreateSave;\n\t\t\tquickCreateParams['noCache'] = true;\n\t\t\tVtiger_Header_Js.getInstance().quickCreateModule(referenceModuleName, quickCreateParams);\n\t\t\treturn aDeferred.promise();\n\t\t}\n\t}\n);\n"],"names":["Vtiger_Edit_Js","registerRecordPreSaveEventEvent","form","_super","lockSave","on","recordPreSave","e","data","JSON","parse","app","getMainParams","status","find","val","progress","$","progressIndicator","position","blockInfo","enabled","isClosedStatusSet","recordId","getRecordId","module","preventDefault","AppConnector","request","action","getModuleName","record","done","response","mode","result","hasTimeControl","relatedTicketsClosed","submit","Vtiger_Helper_Js","showPnotify","text","message","type","self","addTimeControl","url","vtranslate","params","jQuery","Deferred","parentId","quickCreateParams","relatedParams","fullFormUrl","preQuickCreateSave","queryParam","queryParamComponents","queryParameters","indexOf","split","queryString","urlSplit","index","length","trigger","appendTo","inArray","eliminatedKeys","Vtiger_Header_Js","getInstance","quickCreateModule","aDeferred","promise"],"mappings":"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"}