'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};

$.Class('Vtiger_Edit_Js',{//Event that will triggered when reference field is selected
referenceSelectionEvent:'Vtiger.Reference.Selection',//Event that will triggered when reference field is selected
referenceDeSelectionEvent:'Vtiger.Reference.DeSelection',//Event that will triggered before saving the record
recordPreSave:'Vtiger.Record.PreSave',editInstance:!1,inventoryController:!1,/**
		 * Function to get Instance by name
		 * @params moduleName:-- Name of the module to create instance
		 */getInstanceByModuleName:function getInstanceByModuleName(moduleName){'undefined'==typeof moduleName&&(moduleName=app.getModuleName());var moduleClassName,fallbackClassName,instance,parentModule=app.getParentModuleName();return 'Settings'===parentModule?(moduleClassName=parentModule+'_'+moduleName+'_Edit_Js','undefined'==typeof window[moduleClassName]&&(moduleClassName=moduleName+'_Edit_Js'),fallbackClassName=parentModule+'_Vtiger_Edit_Js','undefined'==typeof window[fallbackClassName]&&(fallbackClassName='Vtiger_Edit_Js')):(moduleClassName=moduleName+'_Edit_Js',fallbackClassName='Vtiger_Edit_Js'),instance='undefined'==typeof window[moduleClassName]?new window[fallbackClassName]:new window[moduleClassName],instance.moduleName=moduleName,instance},getInstance:function getInstance(){if(!1==Vtiger_Edit_Js.editInstance){var instance=Vtiger_Edit_Js.getInstanceByModuleName();return Vtiger_Edit_Js.editInstance=instance,instance}return Vtiger_Edit_Js.editInstance}},{formElement:!1,relationOperation:'',moduleName:app.getModuleName(),getForm:function getForm(){return !1==this.formElement&&this.setForm($('#EditView')),this.formElement},setForm:function setForm(element){return this.formElement=element,this},getRecordsListParams:function getRecordsListParams(container){var sourceModule=app.getModuleName(),popupReferenceModule=$('input[name="popupReferenceModule"]',container).val(),sourceFieldElement=$('input[class="sourceField"]',container),sourceField=sourceFieldElement.attr('name'),sourceRecordElement=$('input[name="record"]'),sourceRecordId='';0<sourceRecordElement.length&&(sourceRecordId=sourceRecordElement.val());var isMultiple=!1;!0==sourceFieldElement.data('multiple')&&(isMultiple=!0);var filterFields={},formElement=container.closest('form'),mappingRelatedField=formElement.find('input[name="mappingRelatedField"]').val(),mappingRelatedModule=mappingRelatedField?JSON.parse(mappingRelatedField):[];null!=mappingRelatedModule[sourceField]&&null!=mappingRelatedModule[sourceField][popupReferenceModule]&&$.each(mappingRelatedModule[sourceField][popupReferenceModule],function(index){var mapFieldElement=formElement.find('[name="'+index+'"]');mapFieldElement.length&&''!=mapFieldElement.val()&&(filterFields[index]=mapFieldElement.val());});var params={module:popupReferenceModule,src_module:sourceModule,src_field:sourceField,src_record:sourceRecordId,filterFields:filterFields},searchParamsElement=$('input[name="searchParams"]',container);return 0<searchParamsElement.length&&(params.search_params=searchParamsElement.val()),$.each(['link','process'],function(index,value){var fieldElement=formElement.find('[name="'+value+'"]');fieldElement.length&&''!=fieldElement.val()&&0!=fieldElement.val()&&(params[value]=fieldElement.val());}),isMultiple&&(params.multi_select=!0),params},/**
		 * Show records list modal
		 * @param {jQuery.Event} e
		 */showRecordsList:function showRecordsList(e){var _this=this,parentElem=$(e.target).closest('.fieldValue');0>=parentElem.length&&(parentElem=$(e.target).closest('td'));var params=this.getRecordsListParams(parentElem);app.showRecordsList(params,function(modal,instance){instance.setSelectEvent(function(data){_this.setReferenceFieldValue(parentElem,data);});});},setReferenceFieldValue:function setReferenceFieldValue(container,params){var thisInstance=this,sourceFieldElement=container.find('input.sourceField'),sourceField=sourceFieldElement.attr('name'),fieldElement=container.find('input[name="'+sourceField+'"]'),fieldDisplayElement=container.find('input[name="'+(sourceField+'_display')+'"]'),popupReferenceModule=container.find('input[name="popupReferenceModule"]').val(),selectedName=params.name,id=params.id;if(container.find('.clearReferenceSelection').trigger('click'),fieldElement.val(id),fieldDisplayElement.val(app.decodeHTML(selectedName)).attr('readonly',!0),fieldElement.trigger(Vtiger_Edit_Js.referenceSelectionEvent,{module:popupReferenceModule,record:id,selectedName:selectedName}),fieldDisplayElement.validationEngine('closePrompt',fieldDisplayElement),'inventory'==sourceFieldElement.data('type'))return params;var formElement=container.closest('form'),mappingRelatedField=this.getMappingRelatedField(sourceField,popupReferenceModule,formElement);if('undefined'!=typeof mappingRelatedField){var _params={module:popupReferenceModule,record:id};app.getRecordDetails(_params).done(function(data){var response=_params.data=data.result.data;app.event.trigger('EditView.SelectReference',_params,formElement),$.each(mappingRelatedField,function(key,value){if(0!=response[value[0]]&&!thisInstance.getMappingValuesFromUrl(key)){var mapFieldElement=formElement.find('[name="'+key+'"]'),fieldinfo=mapFieldElement.data('fieldinfo');if('date'===data.result.type[value[0]]||'datetime'===data.result.type[value[0]])mapFieldElement.val(data.result.displayData[value[0]]);else if('multipicklist'===data.result.type[value[0]]){var mapFieldElementMultiselect=formElement.find('[name="'+key+'[]"]');if(0<mapFieldElementMultiselect.length){var multipleAttr=mapFieldElement.attr('multiple'),splitValues=response[value[0]].split(' |##| ');'undefined'!=typeof multipleAttr&&!1!==multipleAttr&&0<splitValues.length&&mapFieldElementMultiselect.val(splitValues).trigger('change');}}else if(!mapFieldElement.is('select'))0==mapFieldElement.length?$('<input type=\'hidden\'/>').attr('name',key).attr('value',response[value[0]]).appendTo(formElement):mapFieldElement.val(response[value[0]]);else if(mapFieldElement.find('option[value="'+response[value[0]]+'"]').length)mapFieldElement.val(response[value[0]]).trigger('change');else if(mapFieldElement.data('fieldinfo').picklistvalues.hasOwnProperty(response[value[0]])){var newOption=new Option(response[value[0]],response[value[0]],!0,!0);mapFieldElement.append(newOption).trigger('change');}var mapFieldDisplayElement=formElement.find('input[name="'+key+'_display"]');if(0<mapFieldDisplayElement.length&&(mapFieldDisplayElement.val(data.result.displayData[value[0]]).attr('readonly',!0),'reference'===fieldinfo.type)){var referenceModulesList=mapFieldElement.closest('.fieldValue').find('.referenceModulesList');0<referenceModulesList.length&&value[1]&&referenceModulesList.val(value[1]).trigger('change'),thisInstance.setReferenceFieldValue(mapFieldDisplayElement.closest('.fieldValue'),{name:data.result.displayData[value[0]],id:response[value[0]]});}}});});}},getRelationOperation:function getRelationOperation(){if(''===this.relationOperation){var relationOperation=$('[name="relationOperation"]');this.relationOperation=!!relationOperation.length&&relationOperation.val();}return this.relationOperation},getMappingValuesFromUrl:function getMappingValuesFromUrl(key){var relationOperation=this.getRelationOperation();return !!relationOperation&&app.getUrlVar(key)},proceedRegisterEvents:function proceedRegisterEvents(){return !!(0<$('.recordEditView').length)},referenceModulePopupRegisterEvent:function referenceModulePopupRegisterEvent(container){var _this2=this;container.on('click','.relatedPopup',function(e){_this2.showRecordsList(e);});var moduleList=container.find('.referenceModulesList');App.Fields.Picklist.showSelect2ElementView(container.find('.referenceModulesList:visible')),moduleList.on('change',function(e){var element=$(e.currentTarget),parentElem=element.closest('.fieldValue'),popupReferenceModule=element.val(),referenceModuleElement=$('input[name="popupReferenceModule"]',parentElem),prevSelectedReferenceModule=referenceModuleElement.val();referenceModuleElement.val(popupReferenceModule),prevSelectedReferenceModule!=popupReferenceModule&&parentElem.find('.clearReferenceSelection').trigger('click');});},getReferencedModuleName:function getReferencedModuleName(parenElement){return $('input[name="popupReferenceModule"]',parenElement).val()},searchModuleNames:function searchModuleNames(params){var aDeferred=$.Deferred();return 'undefined'==typeof params.module&&(params.module=app.getModuleName()),'undefined'==typeof params.action&&(params.action='BasicAjax'),AppConnector.request(params).done(function(data){aDeferred.resolve(data);}).fail(function(){aDeferred.reject();}),aDeferred.promise()},/**
		 * Function to get reference search params
		 */getReferenceSearchParams:function getReferenceSearchParams(element){var tdElement=$(element).closest('.fieldValue'),params={},searchModule=this.getReferencedModuleName(tdElement);return params.search_module=searchModule,params},/**
		 * Function which will handle the reference auto complete event registrations
		 * @params - container <jQuery> - element in which auto complete fields needs to be searched
		 */registerAutoCompleteFields:function registerAutoCompleteFields(container){var thisInstance=this;container.find('input.autoComplete').autocomplete({delay:'600',minLength:'3',source:function source(request,response){//element will be array of dom elements
//here this refers to auto complete instance
var inputElement=$(this.element[0]),searchValue=request.term,params=thisInstance.getReferenceSearchParams(inputElement);//params.parent_id = app.getRecordId();
//params.parent_module = app.getModuleName();
params.search_value=searchValue,thisInstance.searchModuleNames(params).done(function(data){var reponseDataList=[],serverDataFormat=data.result;for(var id in 0>=serverDataFormat.length&&($(inputElement).val(''),serverDataFormat=new Array({label:app.vtranslate('JS_NO_RESULTS_FOUND'),type:'no results'})),serverDataFormat){var responseData=serverDataFormat[id];reponseDataList.push(responseData);}response(reponseDataList),app.event.trigger('EditView.AfterSearch',{field:inputElement,params:params});});},select:function select(event,ui){var selectedItemData=ui.item;//To stop selection if no results is selected
if('undefined'!=typeof selectedItemData.type&&'no results'==selectedItemData.type)return !1;selectedItemData.name=selectedItemData.value;var element=$(this),tdElement=element.closest('.fieldValue');thisInstance.setReferenceFieldValue(tdElement,selectedItemData);},change:function change(){var element=$(this);//if you dont have readonly attribute means the user didnt select the item
element.attr('readonly')==null&&element.closest('.fieldValue').find('.clearReferenceSelection').trigger('click');},open:function open(){//To Make the menu come up in the case of quick create
$(this).data('ui-autocomplete').menu.element.css('z-index','100001');}});},/**
		 * Function which will register reference field clear event
		 * @params - container <jQuery> - element in which auto complete fields needs to be searched
		 */registerClearReferenceSelectionEvent:function registerClearReferenceSelectionEvent(container){var thisInstance=this;container.on('click','.clearReferenceSelection',function(e){var element=$(e.currentTarget);thisInstance.clearFieldValue(element),element.closest('.fieldValue').find('.sourceField').trigger(Vtiger_Edit_Js.referenceDeSelectionEvent),e.preventDefault();});},clearFieldValue:function clearFieldValue(element){var self=this,fieldValueContener=element.closest('.fieldValue'),fieldNameElement=fieldValueContener.find('.sourceField'),fieldName=fieldNameElement.attr('name'),referenceModule=fieldValueContener.find('input[name="popupReferenceModule"]').val(),formElement=fieldValueContener.closest('form');'reference'==fieldNameElement.data('fieldtype')?fieldNameElement.val(0):fieldNameElement.val(''),fieldValueContener.find('#'+fieldName+'_display').removeAttr('readonly').val(''),app.event.trigger('EditView.ClearField',{fieldName:fieldName,referenceModule:referenceModule});var mappingRelatedField=this.getMappingRelatedField(fieldName,referenceModule,formElement);$.each(mappingRelatedField,function(key,value){var mapFieldElement=formElement.find('[name="'+key+'"]');mapFieldElement.is('select')?mapFieldElement.val(mapFieldElement.find('option:first').val()).trigger('change'):mapFieldElement.val('');var mapFieldDisplayElement=formElement.find('input[name="'+key+'_display"]');if(0<mapFieldDisplayElement.length){mapFieldDisplayElement.val('').attr('readonly',!1);var referenceModulesList=formElement.find('#'+self.moduleName+'_editView_fieldName_'+key+'_dropDown');0<referenceModulesList.length&&value[1]&&referenceModulesList.val(referenceModulesList.find('option:first').val()).trigger('change');}});},/**
		 * Function which will register event to prevent form submission on pressing on enter
		 * @params - container <jQuery> - element in which auto complete fields needs to be searched
		 */registerPreventingEnterSubmitEvent:function registerPreventingEnterSubmitEvent(container){container.on('keypress',function(e){//Stop the submit when enter is pressed in the form
var currentElement=$(e.target);13!=e.which||currentElement.is('textarea')||e.preventDefault();});},registerTimeFields:function registerTimeFields(container){app.registerEventForClockPicker(),App.Fields.Date.register(container),App.Fields.DateTime.register(container);},referenceCreateHandler:function referenceCreateHandler(container){var thisInstance=this,params={callbackFunction:function postQuickCreateSave(data){thisInstance.setReferenceFieldValue(container,{name:data.result._recordLabel,id:data.result._recordId});}};if('Edit'===app.getViewName()&&!app.getRecordId()){var formElement=this.getForm(),formData=formElement.serializeFormData();for(var i in formData)formData[i]&&-1==$.inArray(i,['_csrf','action'])||delete formData[i];params.data={},params.data.sourceRecordData=formData;}var referenceModuleName=this.getReferencedModuleName(container);Vtiger_Header_Js.getInstance().quickCreateModule(referenceModuleName,params);},/**
		 * Function which will register event for create of reference record
		 * This will allow users to create reference record from edit view of other record
		 */registerReferenceCreate:function registerReferenceCreate(container){var thisInstance=this;container.on('click','.createReferenceRecord',function(e){var element=$(e.currentTarget),controlElementDiv=element.closest('.fieldValue');thisInstance.referenceCreateHandler(controlElementDiv);});},addressFieldsMapping:['buildingnumber','localnumber','addresslevel1','addresslevel2','addresslevel3','addresslevel4','addresslevel5','addresslevel6','addresslevel7','addresslevel8','pobox'],addressFieldsMappingBlockID:{LBL_ADDRESS_INFORMATION:'a',LBL_ADDRESS_BILLING:'a',LBL_ADDRESS_MAILING_INFORMATION:'b',LBL_ADDRESS_SHIPPING:'b',LBL_ADDRESS_DELIVERY_INFORMATION:'c'},addressFieldsData:!1,/**
		 * Function to register event for copying addresses
		 */registerEventForCopyAddress:function registerEventForCopyAddress(){var thisInstance=this,account_id=!1,contact_id=!1,lead_id=!1,vendor_id=!1;$('#EditView .js-toggle-panel:not(.inventoryHeader):not(.inventoryItems) .fieldValue, #EditView .js-toggle-panel:not(.inventoryHeader):not(.inventoryItems) .fieldLabel').each(function(){var block=$(this),referenceModulesList=!1,relatedField=block.find('[name="popupReferenceModule"]').val();'Accounts'==relatedField&&(account_id=block.find('.sourceField').attr('name')),'Contacts'==relatedField&&(contact_id=block.find('.sourceField').attr('name')),'Leads'==relatedField&&(lead_id=block.find('.sourceField').attr('name')),'Vendors'==relatedField&&(vendor_id=block.find('.sourceField').attr('name')),referenceModulesList=block.find('.referenceModulesList'),0<referenceModulesList.length&&$.each(referenceModulesList.find('option'),function(key,data){'Accounts'==data.value&&(account_id=block.find('.sourceField').attr('name')),'Contacts'==data.value&&(contact_id=block.find('.sourceField').attr('name')),'Leads'==data.value&&(lead_id=block.find('.sourceField').attr('name')),'Vendors'==data.value&&(vendor_id=block.find('.sourceField').attr('name'));});}),!1==account_id?$('.copyAddressFromAccount').addClass('d-none'):$('.copyAddressFromAccount').on('click',function(){var element=$(this),block=element.closest('.js-toggle-panel'),from=element.data('label'),to=block.data('label'),recordRelativeAccountId=$('[name="'+account_id+'"]').val();if(''==recordRelativeAccountId||'0'==recordRelativeAccountId)Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_PLEASE_SELECT_AN_ACCOUNT_TO_COPY_ADDRESS'));else {var recordRelativeAccountName=$('#'+account_id+'_display').val();thisInstance.copyAddressDetails(from,to,{record:recordRelativeAccountId,selectedName:recordRelativeAccountName,module:'Accounts'},element.closest('.js-toggle-panel')),element.attr('checked','checked');}}),!1==contact_id?$('.copyAddressFromContact').addClass('d-none'):$('.copyAddressFromContact').on('click',function(){var element=$(this),block=element.closest('.js-toggle-panel'),from=element.data('label'),to=block.data('label'),recordRelativeAccountId=$('[name="'+contact_id+'"]').val();if(''==recordRelativeAccountId||'0'==recordRelativeAccountId)Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_PLEASE_SELECT_AN_CONTACT_TO_COPY_ADDRESS'));else {var recordRelativeAccountName=$('#'+contact_id+'_display').val();thisInstance.copyAddressDetails(from,to,{record:recordRelativeAccountId,selectedName:recordRelativeAccountName,module:'Contacts'},element.closest('.js-toggle-panel')),element.attr('checked','checked');}}),!1==lead_id?$('.copyAddressFromLead').addClass('d-none'):$('.copyAddressFromLead').on('click',function(){var element=$(this),block=element.closest('.js-toggle-panel'),from=element.data('label'),to=block.data('label'),recordRelativeAccountId=$('[name="'+lead_id+'"]').val();if(''==recordRelativeAccountId||'0'==recordRelativeAccountId)Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_PLEASE_SELECT_AN_LEAD_TO_COPY_ADDRESS'));else {var recordRelativeAccountName=$('#'+lead_id+'_display').val();thisInstance.copyAddressDetails(from,to,{record:recordRelativeAccountId,selectedName:recordRelativeAccountName,module:'Leads'},element.closest('.js-toggle-panel')),element.attr('checked','checked');}}),!1==vendor_id?$('.copyAddressFromVendor').addClass('d-none'):$('.copyAddressFromVendor').on('click',function(){var element=$(this),block=element.closest('.js-toggle-panel'),from=element.data('label'),to=block.data('label'),recordRelativeAccountId=$('[name="'+vendor_id+'"]').val();if(''==recordRelativeAccountId||'0'==recordRelativeAccountId)Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_PLEASE_SELECT_AN_VENDOR_TO_COPY_ADDRESS'));else {var recordRelativeAccountName=$('#'+vendor_id+'_display').val();thisInstance.copyAddressDetails(from,to,{record:recordRelativeAccountId,selectedName:recordRelativeAccountName,module:'Vendors'},element.closest('.js-toggle-panel')),element.attr('checked','checked');}}),$('#EditView .js-toggle-panel').each(function(){var hideCopyAddressLabel=!0;$(this).find('.adressAction button').each(function(){!1==$(this).hasClass('d-none')&&(hideCopyAddressLabel=!1);}),hideCopyAddressLabel&&$(this).find('.copyAddressLabel').addClass('d-none');}),$('.copyAddressFromMain').on('click',function(){var element=$(this),block=element.closest('.js-toggle-panel'),from=element.data('label'),to=block.data('label');thisInstance.copyAddress(from,to,!1,!1);}),$('.copyAddressFromMailing').on('click',function(){var element=$(this),block=element.closest('.js-toggle-panel'),from=element.data('label'),to=block.data('label');thisInstance.copyAddress(from,to,!1,!1);}),$('.copyAddressFromDelivery').on('click',function(){var element=$(this),block=element.closest('.js-toggle-panel'),from=element.data('label'),to=block.data('label');thisInstance.copyAddress(from,to,!1,!1);});},/**
		 * Function which will copy the address details
		 */copyAddressDetails:function copyAddressDetails(from,to,data){var thisInstance=this,sourceModule=data.module;app.getRecordDetails(data).done(function(data){var response=data.result;thisInstance.addressFieldsData=response,thisInstance.copyAddress(from,to,!0,sourceModule);});},/**
		 * Function to copy address between fields
		 * @param strings which accepts value as either odd or even
		 */copyAddress:function copyAddress(fromLabel,toLabel,relatedRecord,sourceModule){var thisInstance=this,formElement=this.getForm(),status=!1,addressMapping=this.addressFieldsMapping,BlockIds=this.addressFieldsMappingBlockID,from=BlockIds[fromLabel];(!1===relatedRecord||!1===sourceModule)&&(from=BlockIds[fromLabel]);var key,fromElement,fromElementLabel,nameElementFrom,nameElementTo,to=BlockIds[toLabel];for(key in addressMapping){nameElementFrom=addressMapping[key]+from,nameElementTo=addressMapping[key]+to,relatedRecord?(fromElement=thisInstance.addressFieldsData.data[nameElementFrom],fromElementLabel=thisInstance.addressFieldsData.displayData[nameElementFrom]):(fromElement=formElement.find('[name="'+nameElementFrom+'"]').val(),fromElementLabel=formElement.find('[name="'+nameElementFrom+'_display"]').val());var toElement=formElement.find('[name="'+nameElementTo+'"]'),toElementLable=formElement.find('[name="'+nameElementTo+'_display"]');''!==fromElement&&'0'!==fromElement&&fromElement!==void 0?(0<toElementLable.length&&toElementLable.attr('readonly',!0),status=!0,toElement.val(fromElement),toElementLable.val(fromElementLabel),toElement.is('[data-select2-id]')&&(toElement.val()!==fromElement&&toElement.val(''),toElement.trigger('change'))):toElement.attr('readonly',!1);}if(!1==status){var errorMsg;errorMsg='Accounts'===sourceModule?'JS_SELECTED_ACCOUNT_DOES_NOT_HAVE_AN_ADDRESS':'Contacts'===sourceModule?'JS_SELECTED_CONTACT_DOES_NOT_HAVE_AN_ADDRESS':'JS_DOES_NOT_HAVE_AN_ADDRESS',Vtiger_Helper_Js.showPnotify(app.vtranslate(errorMsg));}},registerReferenceSelectionEvent:function registerReferenceSelectionEvent(container){var thisInstance=this,relategField=container.find('input[name*=\'addresslevel\']');relategField.on(Vtiger_Edit_Js.referenceSelectionEvent,function(e,data){var blockContainer=$(e.currentTarget).closest('.js-toggle-panel');thisInstance.copyAddressDetailsRef(data,blockContainer);});},copyAddressDetailsRef:function copyAddressDetailsRef(data,container){var thisInstance=this;app.getRecordDetails(data).done(function(data){var response=data.result;thisInstance.mapAddressDetails(response,container);}).fail(function(){});},mapAddressDetails:function mapAddressDetails(result,container){for(var key in result)-1!=key.indexOf('addresslevel')&&(0!=container.find('[name="'+key+'"]').length&&(container.find('[name="'+key+'"]').val(result.data[key]),container.find('[name="'+key+'"]').attr('readonly',!0),container.find('[name="'+key+'_display"]').val(result.displayData[key]),container.find('[name="'+key+'_display"]').attr('readonly',!0)),0!=container.find('[name="'+key+'a"]').length&&0==container.find('[name="'+key+'a"]').val()&&0!=result.data[key]&&(container.find('[name="'+key+'a"]').val(result.data[key]),container.find('[name="'+key+'a"]').attr('readonly',!0),container.find('[name="'+key+'a_display"]').val(result.displayData[key]),container.find('[name="'+key+'a_display"]').attr('readonly',!0)),0!=container.find('[name="'+key+'b"]').length&&0==container.find('[name="'+key+'b"]').val()&&0!=result.data[key]&&(container.find('[name="'+key+'b"]').val(result.data[key]),container.find('[name="'+key+'b"]').attr('readonly',!0),container.find('[name="'+key+'b_display"]').val(result.displayData[key]),container.find('[name="'+key+'b_display"]').attr('readonly',!0)),0!=container.find('[name="'+key+'c"]').length&&0==container.find('[name="'+key+'c"]').val()&&0!=result.data[key]&&(container.find('[name="'+key+'c"]').val(result.data[key]),container.find('[name="'+key+'c"]').attr('readonly',!0),container.find('[name="'+key+'c_display"]').val(result.displayData[key]),container.find('[name="'+key+'c_display"]').attr('readonly',!0)));},registerMaskFields:function registerMaskFields(container){container.find('[data-inputmask]').inputmask();},triggerDisplayTypeEvent:function triggerDisplayTypeEvent(){var widthType=app.cacheGet('widthType','narrowWidthType');if(widthType){var elements=$('#EditView').find('.fieldValue,.fieldLabel');elements.addClass(widthType);}},registerSubmitEvent:function registerSubmitEvent(){var editViewForm=this.getForm();editViewForm.on('submit',function(e){//Form should submit only once for multiple clicks also
if('undefined'!=typeof editViewForm.data('submit'))return !1;if(document.progressLoader=$.progressIndicator({message:app.vtranslate('JS_SAVE_LOADER_INFO'),position:'html',blockInfo:{enabled:!0}}),editViewForm.find('.js-toggle-panel').find('.js-block-content').removeClass('d-none'),editViewForm.validationEngine('validate')){editViewForm.data('submit','true');//on submit form trigger the recordPreSave event
var recordPreSaveEvent=$.Event(Vtiger_Edit_Js.recordPreSave);editViewForm.trigger(recordPreSaveEvent,{value:'edit'}),recordPreSaveEvent.isDefaultPrevented()&&(document.progressLoader.progressIndicator({mode:'hide'}),editViewForm.removeData('submit'),e.preventDefault());}else//If validation fails, form should submit again
document.progressLoader.progressIndicator({mode:'hide'}),editViewForm.removeData('submit'),app.formAlignmentAfterValidation(editViewForm);});},/*
		 * Function to check the view permission of a record after save
		 */registerRecordPreSaveEventEvent:function registerRecordPreSaveEventEvent(form){var _this3=this;form.on(Vtiger_Edit_Js.recordPreSave,function(e){_this3.preSaveValidation(form).done(function(response){!0!==response&&e.preventDefault();});});},preSaveValidation:function preSaveValidation(form){var aDeferred=$.Deferred();if(form.find('#preSaveValidation').val()){document.progressLoader=$.progressIndicator({message:app.vtranslate('JS_SAVE_LOADER_INFO'),position:'html',blockInfo:{enabled:!0}});var formData=new FormData(form[0]);formData.append('mode','preSaveValidation'),AppConnector.request({async:!1,url:'index.php',type:'POST',data:formData,processData:!1,contentType:!1}).done(function(data){document.progressLoader.progressIndicator({mode:'hide'});for(var response=data.result,i=0;i<response.length;i++)!0!==response[i].result&&(Vtiger_Helper_Js.showPnotify(response[i].message?response[i].message:app.vtranslate('JS_ERROR')),null!=response[i].hoverField&&form.find('[name="'+response[i].hoverField+'"]').focus());0>=data.result.length?aDeferred.resolve(!0):aDeferred.resolve(!1);}).fail(function(textStatus,errorThrown){document.progressLoader.progressIndicator({mode:'hide'}),Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_ERROR')),app.errorLog(textStatus,errorThrown),aDeferred.resolve(!1);});}else aDeferred.resolve(!0);return aDeferred.promise()},/**
		 * Function to register event for setting up picklistdependency
		 * for a module if exist on change of picklist value
		 */registerEventForPicklistDependencySetup:function registerEventForPicklistDependencySetup(container){var picklistDependcyElemnt=$('[name="picklistDependency"]',container);if(!(0>=picklistDependcyElemnt.length)){var picklistDependencyMapping=JSON.parse(picklistDependcyElemnt.val()),sourcePicklists=Object.keys(picklistDependencyMapping);if(!(0>=sourcePicklists.length)){var i,sourcePickListNames=[];for(i=0;i<sourcePicklists.length;i++)sourcePickListNames.push('[name="'+sourcePicklists[i]+'"]');sourcePickListNames=sourcePickListNames.join(',');var sourcePickListElements=container.find(sourcePickListNames);sourcePickListElements.on('change',function(e){var currentElement=$(e.currentTarget),configuredDependencyObject=picklistDependencyMapping[currentElement.attr('name')],targetObjectForSelectedSourceValue=configuredDependencyObject[currentElement.val()],picklistmap=configuredDependencyObject.__DEFAULT__;'undefined'==typeof targetObjectForSelectedSourceValue&&(targetObjectForSelectedSourceValue=picklistmap),$.each(picklistmap,function(targetPickListName,targetPickListValues){var targetPickListMap=targetObjectForSelectedSourceValue[targetPickListName];'undefined'==typeof targetPickListMap&&(targetPickListMap=targetPickListValues);var targetPickList=$('[name="'+targetPickListName+'"]',container);if(!(0>=targetPickList.length)){var listOfAvailableOptions=targetPickList.data('availableOptions');'undefined'==typeof listOfAvailableOptions&&(listOfAvailableOptions=$('option',targetPickList),targetPickList.data('available-options',listOfAvailableOptions));var targetOptions=new $,optionSelector=[];for(optionSelector.push(''),i=0;i<targetPickListMap.length;i++)optionSelector.push(targetPickListMap[i]);$.each(listOfAvailableOptions,function(i,e){-1!==$.inArray($(e).val(),optionSelector)&&(targetOptions=targetOptions.add($(e)));}),targetPickList.html(targetOptions).val(targetOptions.filter('[selected]').val()).trigger('change');}});}),sourcePickListElements.trigger('change');}}},registerLeavePageWithoutSubmit:function registerLeavePageWithoutSubmit(form){if('undefined'!=typeof CKEDITOR&&'undefined'!=typeof CKEDITOR.instances&&Object.keys(CKEDITOR.instances).length)CKEDITOR.on('instanceReady',function(){var initialFormData=form.serialize();window.onbeforeunload=function(){if(initialFormData!=form.serialize()&&'true'!=form.data('submit'))return app.vtranslate('JS_CHANGES_WILL_BE_LOST')};});else {var initialFormData=form.serialize();window.onbeforeunload=function(){if(initialFormData!=form.serialize()&&'true'!=form.data('submit'))return app.vtranslate('JS_CHANGES_WILL_BE_LOST')};}},stretchCKEditor:function stretchCKEditor(){var row=$('.js-editor').parents('.fieldRow'),td=$('.js-editor').parent();$(row).find('.fieldLabel').remove(),$(td).removeClass('col-md-10'),$(td).addClass('col-md-12');},/**
		 * Function to register event for ckeditor for description field
		 */registerEventForEditor:function registerEventForEditor(){var form=this.getForm(),thisInstance=this;$.each(form.find('.js-editor'),function(key,data){thisInstance.loadEditorElement($(data));});},loadEditorElement:function loadEditorElement(noteContentElement){var customConfig={};noteContentElement.hasClass('js-editor--basic')&&(customConfig.toolbar='Min'),noteContentElement.data('height')&&(customConfig.height=noteContentElement.data('height')),new App.Fields.Text.Editor(noteContentElement,customConfig);},registerHelpInfo:function registerHelpInfo(){var form=this.getForm();app.showPopoverElementView(form.find('.js-help-info'));},registerBlockAnimationEvent:function registerBlockAnimationEvent(){var detailContentsHolder=this.getForm();detailContentsHolder.on('click','.blockHeader',function(e){var target=$(e.target);if(target.is('input')||target.is('button')||target.parents().is('button')||target.hasClass('js-stop-propagation')||target.parents().hasClass('js-stop-propagation'))return !1;var currentTarget=$(e.currentTarget).find('.js-block-toggle').not('.d-none'),blockId=currentTarget.data('id'),closestBlock=currentTarget.closest('.js-toggle-panel'),bodyContents=closestBlock.find('.blockContent'),data=currentTarget.data(),module=app.getModuleName();'show'==data.mode?(function hideHandler(){bodyContents.addClass('d-none'),app.cacheSet(module+'.'+blockId,0);}(),currentTarget.addClass('d-none'),closestBlock.find('[data-mode="hide"]').removeClass('d-none')):(function showHandler(){bodyContents.removeClass('d-none'),app.cacheSet(module+'.'+blockId,1);}(),currentTarget.addClass('d-none'),closestBlock.find('[data-mode=\'show\']').removeClass('d-none'));});},registerBlockStatusCheckOnLoad:function registerBlockStatusCheckOnLoad(){var blocks=this.getForm().find('.js-toggle-panel'),module=app.getModuleName();blocks.each(function(index,block){var currentBlock=$(block),dynamicAttr=currentBlock.attr('data-dynamic');if(('undefined'==typeof dynamicAttr?'undefined':_typeof(dynamicAttr))!=='undefined'&&!1!==dynamicAttr){var headerAnimationElement=currentBlock.find('.js-block-toggle').not('.d-none'),bodyContents=currentBlock.find('.blockContent'),blockId=headerAnimationElement.data('id'),value=app.cacheGet(module+'.'+blockId,null);null!=value&&(1==value?(headerAnimationElement.addClass('d-none'),currentBlock.find('[data-mode=\'show\']').removeClass('d-none'),bodyContents.removeClass('d-none')):(headerAnimationElement.addClass('d-none'),currentBlock.find('[data-mode=\'hide\']').removeClass('d-none'),bodyContents.addClass('d-none')));}});},registerAutoloadAddress:function registerAutoloadAddress(){this.getForm().find('.js-search-address').each(function(index,item){var search=$(item),container=search.closest('.js-block-content'),input=search.find('.js-autoload-address');input.autocomplete({source:function source(request,response){AppConnector.request({module:app.getModuleName(),action:'Fields',mode:'findAddress',type:search.find('.js-select-operator').val(),value:request.term}).done(function(requestData){!1===requestData.result?Vtiger_Helper_Js.showPnotify(app.vtranslate('JS_ERROR')):requestData.result.length?response(requestData.result):response([{label:app.vtranslate('JS_NO_RESULTS_FOUND'),value:''}]);}).fail(function(textStatus,errorThrown,jqXHR){Vtiger_Helper_Js.showPnotify({text:jqXHR.responseJSON.error.message,type:'error',animation:'show'}),response([{label:app.vtranslate('JS_NO_RESULTS_FOUND'),value:''}]);});},minLength:input.data('min'),select:function select(event,ui){$.each(ui.item.address,function(index,value){var field=container.find('.fieldValue [name^='+index+']');field.length&&value?('object'!==('undefined'==typeof value?'undefined':_typeof(value))&&(value=[value]),$.each(value,function(index,v){var select=!1,element=!1;'SELECT'===field.prop('tagName')?'object'===('undefined'==typeof v?'undefined':_typeof(v))?$.each(v,function(index,x){element=field.find('option[data-'+index+'=\''+x+'\']'),x&&element.length&&(select=element.val());}):(element=field.find('option:contains('+v+')'),v&&element.length&&(select=element.val()),element=field.find('option[value="'+v+'"]'),v&&element.length&&(select=element.val())):select=v,select&&field.val(select).change();})):field.val('').change();}),ui.item.value=input.val();}});});},setEnabledFields:function setEnabledFields(element){var fieldValue=element.closest('.fieldValue'),fieldName=fieldValue.find('input.sourceField').attr('name'),fieldDisplay=fieldValue.find('#'+fieldName+'_display');fieldValue.find('button').removeAttr('disabled'),''==fieldDisplay.val()&&fieldValue.find('input').removeAttr('readonly'),fieldValue.find('.referenceModulesListGroup').removeClass('d-none');var placeholder=fieldDisplay.attr('placeholderDisabled');fieldDisplay.removeAttr('placeholderDisabled'),fieldDisplay.attr('placeholder',placeholder),fieldValue.find('.referenceModulesList').attr('required','required');},setDisabledFields:function setDisabledFields(element){var fieldValue=element.closest('.fieldValue'),fieldName=fieldValue.find('input.sourceField').attr('name'),fieldDisplay=fieldValue.find('#'+fieldName+'_display');fieldValue.find('input').attr('readonly','readonly'),fieldValue.find('button').attr('disabled','disabled'),fieldValue.find('.referenceModulesListGroup').addClass('d-none');var placeholder=fieldDisplay.attr('placeholder');fieldDisplay.removeAttr('placeholder'),fieldDisplay.attr('placeholderDisabled',placeholder),fieldValue.find('.referenceModulesList').removeAttr('required');},getMappingRelatedField:function getMappingRelatedField(sourceField,sourceFieldModule,container){var mappingRelatedField=container.find('input[name="mappingRelatedField"]').val(),mappingRelatedModule=mappingRelatedField?JSON.parse(mappingRelatedField):[];return 'undefined'!=typeof mappingRelatedModule[sourceField]&&'undefined'!=typeof mappingRelatedModule[sourceField][sourceFieldModule]?mappingRelatedModule[sourceField][sourceFieldModule]:[]},registerValidationsFields:function registerValidationsFields(container){var params=app.validationEngineOptionsForRecord;container.validationEngine(params);},checkReferencesField:function checkReferencesField(container,clear){var thisInstance=this,activeProcess=!1,activeSubProcess=!1;return !!CONFIG.fieldsReferencesDependent&&void(container.find('input[data-fieldtype="referenceLink"]').each(function(index,element){element=$(element);var t=!0;0<element.closest('.tab-pane').length&&(t=!1,0<element.closest('.tab-pane.active').length&&(t=!0));var referenceLink=element.val();t&&''!=referenceLink&&'0'!=referenceLink&&(activeProcess=!0);}),container.find('input[data-fieldtype="referenceProcess"]').each(function(index,element){element=$(element),activeProcess?thisInstance.setEnabledFields(element):(clear&&thisInstance.clearFieldValue(element),thisInstance.setDisabledFields(element));var t=!0;0<element.closest('.tab-pane').length&&(t=!1,0<element.closest('.tab-pane.active').length&&(t=!0));var referenceLink=element.val();t&&''!=referenceLink&&'0'!=referenceLink&&(activeSubProcess=!0);}),container.find('input[data-fieldtype="referenceSubProcess"]').each(function(index,element){element=$(element);var processfieldElement=element.closest('.fieldValue'),length=processfieldElement.find('.referenceModulesList option[disabled!="disabled"]').length;activeSubProcess&&0<length?thisInstance.setEnabledFields(element):(clear&&thisInstance.clearFieldValue(element),thisInstance.setDisabledFields(element));}))},checkSubProcessModulesList:function checkSubProcessModulesList(element){var option=element.find('option:selected');1==option.data('is-quickcreate')?element.closest('.fieldValue').find('.createReferenceRecord').removeClass('d-none'):element.closest('.fieldValue').find('.createReferenceRecord').addClass('d-none');},checkReferenceModulesList:function checkReferenceModulesList(container){var thisInstance=this,processfieldElement=container.find('input[data-fieldtype="referenceProcess"]').closest('.fieldValue'),referenceProcess=processfieldElement.find('input[name="popupReferenceModule"]').val(),subProcessfieldElement=container.find('input[data-fieldtype="referenceSubProcess"]').closest('.fieldValue');Vtiger_Helper_Js.hideOptions(subProcessfieldElement.find('.referenceModulesList'),'parent',referenceProcess);var subProcessValue=subProcessfieldElement.find('.referenceModulesList').val();subProcessfieldElement.find('[name="popupReferenceModule"]').val(subProcessValue),thisInstance.checkSubProcessModulesList(subProcessfieldElement.find('.referenceModulesList'));},registerReferenceFields:function registerReferenceFields(container){var thisInstance=this;return !!CONFIG.fieldsReferencesDependent&&void(thisInstance.checkReferenceModulesList(container),thisInstance.checkReferencesField(container,!1),container.find('.sourceField').on(Vtiger_Edit_Js.referenceSelectionEvent,function(){thisInstance.checkReferencesField(container,!0);}),container.find('.sourceField').on(Vtiger_Edit_Js.referenceDeSelectionEvent,function(){thisInstance.checkReferencesField(container,!0);}),container.find('input[data-fieldtype="referenceProcess"]').closest('.fieldValue').find('.referenceModulesList').on('change',function(){thisInstance.checkReferenceModulesList(container);}),container.find('input[data-fieldtype="referenceSubProcess"]').closest('.fieldValue').find('.referenceModulesList').on('change',function(e){thisInstance.checkSubProcessModulesList($(e.currentTarget));}))},registerFocusFirstField:function registerFocusFirstField(container,afterTimeout){var _this4=this,elementToFocus=void 0,elementToFocusTabindex=void 0;return void 0===afterTimeout&&container.closest('.js-modal-container').length?void setTimeout(function(){_this4.registerFocusFirstField(container,!0);},500):void(container.find('.fieldValue input.form-control:not([type=hidden],.dateField,.clockPicker), .fieldValue input[type=checkbox], .select2-selection.form-control').each(function(i,e){var element=$(e);if(!element.prop('readonly')&&!element.prop('disabled')){if(element=element.get(0),'number'!==element.type&&'checkbox'!==element.type&&void 0!==element.value){var elemLen=element.value.length;element.selectionStart=elemLen,element.selectionEnd=elemLen;}0!==i&&elementToFocus||(elementToFocus=element);var tabindex=$(element).attr('tabindex');if(0<tabindex&&void 0===elementToFocusTabindex)return void(elementToFocusTabindex=tabindex);0<tabindex&&tabindex<elementToFocusTabindex&&(elementToFocusTabindex=tabindex,elementToFocus=element);}}),elementToFocus&&elementToFocus.focus())},registerCopyValue:function registerCopyValue(container){container.find('.fieldValue [data-copy-to-field]').on('change',function(e){var element=$(e.currentTarget);container.find('[name="'+element.data('copyToField')+'"]').val(element.val());});},/**
		 * Register multi image upload fields
		 * @param {HTMLElement|jQuery} container
		 */registerMultiImageFields:function registerMultiImageFields(container){return App.Fields.MultiImage.register(container)},/**
		 * Register inventory controller
		 * @param {jQuery} container
		 */registerInventoryController:function registerInventoryController(container){'undefined'!=typeof Vtiger_Inventory_Js&&(this.inventoryController=Vtiger_Inventory_Js.getInventoryInstance(container));},/**
		 * Register record collector modal
		 * @param {jQuery} container
		 */registerRecordCollectorModal:function registerRecordCollectorModal(container){var self=this;container.on('click','.js-record-collector-modal',function(e){e.preventDefault();var element=$(this),formData=container.serializeFormData();formData.view='RecordCollector',formData.collectorType=element.data('type'),delete formData.action,AppConnector.request(formData).done(function(html){app.showModalWindow(html,function(container){var modalForm=container.find('form.js-record-collector__form'),summary=container.find('.js-record-collector__summary');modalForm.on('submit',function(e){summary.html(''),summary.progressIndicator({}),e.preventDefault(),AppConnector.request(modalForm.serializeFormData()).done(function(data){summary.progressIndicator({mode:'hide'}),summary.html(data);});});var recordForm=self.getForm();container.on('click','.js-record-collector__fill_fields',function(){var mappedField=container.find('.formFieldsToRecordMap').val();mappedField=JSON.parse(mappedField),Object.keys(mappedField).forEach(function(key){var input=container.find('[name="'+key+'"]');input.each(function(){if(this.checked){var cellWithValue=$(this).closest('.value'+key).find('.fieldValue').html();recordForm.find('[name="'+mappedField[key]+'"]').setValue(cellWithValue);}});}),app.hideModalWindow(null,'collectorModal');});},{modalId:'collectorModal'});});});},/**
		 * Register account name function
		 * @param {jQuery} container
		 */registerAccountName:function registerAccountName(container){var first=container.find('.js-first-name'),firstInput=first.find('input'),last=container.find('.js-last-name'),lastInput=last.find('input'),full=container.find('.js-account-name'),fullInput=full.find('input'),legalForm=container.find('select[name="legal_form"]'),legalFormVal=legalForm.val();firstInput.keyup(function(){fullInput.val(this.value+'|##|'+lastInput.val());}),lastInput.keyup(function(){fullInput.val(firstInput.val()+'|##|'+this.value);}),legalForm.change(function(){'PLL_NATURAL_PERSON'==this.value?(full.addClass('d-none'),fullInput.val(firstInput.val()+'|##|'+lastInput.val()),first.removeClass('d-none'),last.removeClass('d-none')):'PLL_NATURAL_PERSON'==legalFormVal&&(full.removeClass('d-none'),first.addClass('d-none'),last.addClass('d-none'),fullInput.val('')),legalFormVal=this.value;});},/**
		 * Function which will register basic events which will be used in quick create as well
		 *
		 */registerBasicEvents:function registerBasicEvents(container){this.referenceModulePopupRegisterEvent(container),this.registerAutoCompleteFields(container),this.registerClearReferenceSelectionEvent(container),this.registerPreventingEnterSubmitEvent(container),this.registerTimeFields(container),this.registerEventForPicklistDependencySetup(container),this.registerRecordPreSaveEventEvent(container),this.registerReferenceSelectionEvent(container),this.registerMaskFields(container),this.registerHelpInfo(),this.registerReferenceFields(container),this.registerFocusFirstField(container),this.registerCopyValue(container),this.registerMultiImageFields(container),this.registerReferenceCreate(container),this.registerRecordCollectorModal(container),this.registerAccountName(container),App.Fields.MultiEmail.register(container),App.Fields.MultiDependField.register(container),App.Fields.Tree.register(container),App.Fields.MultiCurrency.register(container),App.Fields.MeetingUrl.register(container);},registerEvents:function registerEvents(){var editViewForm=this.getForm();this.proceedRegisterEvents()&&(this.registerInventoryController(editViewForm),this.registerBlockAnimationEvent(),this.registerBlockStatusCheckOnLoad(),this.registerEventForEditor(),this.stretchCKEditor(),this.registerBasicEvents(editViewForm),this.registerEventForCopyAddress(),this.registerSubmitEvent(),this.registerLeavePageWithoutSubmit(editViewForm),this.registerValidationsFields(editViewForm),this.registerAutoloadAddress(),editViewForm.find('.js-form-submit-btn').prop('disabled',!1));}});
//# sourceMappingURL=Edit.min.js.map
