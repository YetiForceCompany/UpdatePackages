'use strict';

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();

var CustomView=function(){function CustomView(url){var _this=this;classCallCheck(this,CustomView);var progressIndicatorElement=$.progressIndicator();app.showModalWindow(null,url,function(){_this.contentsCotainer=$('.js-filter-modal__container'),_this.advanceFilterInstance=new Vtiger_ConditionBuilder_Js(_this.contentsCotainer.find('.js-condition-builder'),_this.contentsCotainer.find('#sourceModule').val()),_this.advanceFilterInstance.registerEvents(),_this.columnSelectElement=!1,_this.registerEvents(),progressIndicatorElement.progressIndicator({mode:'hide'});});}return createClass(CustomView,[{key:'loadDateFilterValues',value:function loadDateFilterValues(){var selectedDateFilter=$('#standardDateFilter option:selected'),currentDate=selectedDateFilter.data('currentdate'),endDate=selectedDateFilter.data('enddate');$('#standardFilterCurrentDate').val(currentDate),$('#standardFilterEndDate').val(endDate);}/**
	 * Function to get the contents container
	 * @return : jQuery object of contents container
	 */},{key:'getContentsContainer',value:function getContentsContainer(){return !1==this.contentsCotainer&&(this.contentsCotainer=$('.js-filter-modal__container')),this.contentsCotainer}/**
	 * Function to get the view columns selection element
	 * @return : jQuery object of view columns selection element
	 */},{key:'getColumnSelectElement',value:function getColumnSelectElement(){return !1==this.columnSelectElement&&(this.columnSelectElement=$('#viewColumnsSelect')),this.columnSelectElement}/**
	 * Function which will get the selected columns
	 * @return : array of selected values
	 */},{key:'getSelectedColumns',value:function getSelectedColumns(){var columnListSelectElement=this.getColumnSelectElement();return columnListSelectElement.val()}},{key:'saveFilter',value:function saveFilter(){var aDeferred=$.Deferred(),formData=$('#CustomView').serializeFormData();return AppConnector.request(formData,!0).done(function(data){aDeferred.resolve(data);}).fail(function(error){aDeferred.reject(error);}),aDeferred.promise()}},{key:'saveAndViewFilter',value:function saveAndViewFilter(){this.saveFilter().done(function(data){var response=data.result;if(response&&response.success){var url;url='Settings'==app.getParentModuleName()?'index.php?module=CustomView&parent=Settings&view=Index&sourceModule='+$('#sourceModule').val():response.listviewurl,window.location.href=url;}else $.unblockUI(),app.showNotify({title:app.vtranslate('JS_DUPLICATE_RECORD'),text:response.message,type:'error'});});}},{key:'registerIconEvents',value:function registerIconEvents(){this.getContentsContainer().find('.js-filter-preferences').on('change','.js-filter-preference',function(e){var currentTarget=$(e.currentTarget),iconElement=currentTarget.next();currentTarget.prop('checked')?iconElement.removeClass(iconElement.data('unchecked')).addClass(iconElement.data('check')):iconElement.removeClass(iconElement.data('check')).addClass(iconElement.data('unchecked'));});}},{key:'registerBlockToggleEvent',value:function registerBlockToggleEvent(){var container=this.getContentsContainer();container.on('click','.blockHeader',function(e){var target=$(e.target);if(target.is('input')||target.is('button')||target.parents().is('button')||target.hasClass('js-stop-propagation')||target.parents().hasClass('js-stop-propagation'))return !1;var blockHeader=$(e.currentTarget),blockContents=blockHeader.next(),iconToggle=blockHeader.find('.iconToggle');blockContents.hasClass('d-none')?(blockContents.removeClass('d-none'),iconToggle.removeClass(iconToggle.data('hide')).addClass(iconToggle.data('show'))):(blockContents.addClass('d-none'),iconToggle.removeClass(iconToggle.data('show')).addClass(iconToggle.data('hide')));});}},{key:'registerColorEvent',value:function registerColorEvent(){var container=this.getContentsContainer(),picker=container.find('.js-color-picker'),pickerField=picker.find('.js-color-picker__field');picker.on('click',function showPicker(){App.Fields.Colors.showPicker({color:pickerField.val(),bgToUpdate:picker.find('.js-color-picker__color'),fieldToUpdate:pickerField});});}/**
	 * Get list of fields to duplicates
	 * @returns {Array}
	 */},{key:'getDuplicateFields',value:function getDuplicateFields(){var fields=[],container=this.getContentsContainer();return container.find('.js-duplicates-container .js-duplicates-row').each(function(){fields.push({fieldid:$(this).find('.js-duplicates-field').val(),ignore:$(this).find('.js-duplicates-ignore').is(':checked')});}),fields}/**
	 * Register events for block "Find duplicates"
	 */},{key:'registerDuplicatesEvents',value:function registerDuplicatesEvents(){var container=this.getContentsContainer();App.Fields.Picklist.showSelect2ElementView(container.find('.js-duplicates-container .js-duplicates-field')),container.on('click','.js-duplicates-remove',function(){$(this).closest('.js-duplicates-row').remove();}),container.find('.js-duplicate-add-field').on('click',function(){var template=container.find('.js-duplicates-field-template').clone();template.removeClass('d-none'),template.removeClass('js-duplicates-field-template'),App.Fields.Picklist.showSelect2ElementView(template.find('.js-duplicates-field')),container.find('.js-duplicates-container').append(template);});}},{key:'registerSubmitEvent',value:function registerSubmitEvent(select2Element){var _this2=this;$('#CustomView').on('submit',function(e){var selectElement=_this2.getColumnSelectElement();if(100<$('#viewname').val().length)return app.showNotify({title:app.vtranslate('JS_MESSAGE'),text:app.vtranslate('JS_VIEWNAME_ALERT'),type:'error'}),void e.preventDefault();//Mandatory Fields selection validation
//Any one Mandatory Field should select while creating custom view.
var mandatoryFieldsList=JSON.parse($('#mandatoryFieldsList').val()),selectedOptions=selectElement.val(),mandatoryFieldsMissing=!0;if(selectedOptions)for(var i=0;i<selectedOptions.length;i++)if(0<=$.inArray(selectedOptions[i],mandatoryFieldsList)){mandatoryFieldsMissing=!1;break}if(mandatoryFieldsMissing)return selectElement.validationEngine('showPrompt',app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_MANDATORY_FIELD'),'error','topLeft',!0),void e.preventDefault();//Mandatory Fields validation ends
select2Element.validationEngine('hide');var result=$(e.currentTarget).validationEngine('validate');if(!0==result){//handled standard filters saved values.
var stdfilterlist={};''!=$('#standardFilterCurrentDate').val()&&''!=$('#standardFilterEndDate').val()&&'none'!=$('select.standardFilterColumn option:selected').val()&&(stdfilterlist.columnname=$('select.standardFilterColumn option:selected').val(),stdfilterlist.stdfilter=$('select#standardDateFilter option:selected').val(),stdfilterlist.startdate=$('#standardFilterCurrentDate').val(),stdfilterlist.enddate=$('#standardFilterEndDate').val(),$('#stdfilterlist').val(JSON.stringify(stdfilterlist)));//handled advanced filters saved values.
var advfilterlist=_this2.advanceFilterInstance.getConditions();return $('#advfilterlist').val(JSON.stringify(advfilterlist)),$('[name="duplicatefields"]').val(JSON.stringify(_this2.getDuplicateFields())),$('input[name="columnslist"]',_this2.getContentsContainer()).val(JSON.stringify(_this2.getSelectedColumns())),_this2.saveAndViewFilter(),!1}app.formAlignmentAfterValidation($(e.currentTarget));});}/**
	 * Block submit on press enter key
	 */},{key:'registerDisableSubmitOnEnter',value:function registerDisableSubmitOnEnter(){this.getContentsContainer().find('#viewname, [name="color"]').keydown(function(e){13===e.keyCode&&e.preventDefault();});}},{key:'registerEvents',value:function registerEvents(){var _this3=this;this.registerIconEvents(),App.Fields.Text.Editor.register(this.getContentsContainer().find('.js-editor')),App.Fields.Tree.register(this.getContentsContainer()),this.registerBlockToggleEvent(),this.registerColorEvent(),this.registerDuplicatesEvents();var select2Element=App.Fields.Picklist.showSelect2ElementView(this.getColumnSelectElement());this.registerSubmitEvent(select2Element),$('.stndrdFilterDateSelect').datepicker(),$('#standardDateFilter').on('change',function(){_this3.loadDateFilterValues();}),$('#CustomView').validationEngine(app.validationEngineOptions),this.registerDisableSubmitOnEnter();}}]),CustomView}();
//# sourceMappingURL=CustomView.min.js.map
