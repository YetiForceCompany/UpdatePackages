'use strict';

/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */"use strict";jQuery.Class("Settings_TreesManager_Edit_Js",{},{jstreeInstance:!1,jstreeLastID:0,registerEvents:function registerEvents(){var self=this,editContainer=$("#EditView"),jstreeInstance=self.createTree();editContainer.validationEngine(),$(".addNewElementBtn").on("click",function(){var newElement=$("input.addNewElement"),ref=jstreeInstance.jstree(!0);if(""===newElement.val()){var message=app.vtranslate("JS_FIELD_CAN_NOT_BE_EMPTY");return newElement.validationEngine("showPrompt",message,"error","bottomLeft",!0),!1}self.jstreeLastID+=1,ref.create_node("#",{id:self.jstreeLastID,text:newElement.val(),icon:!1},"last"),newElement.val("");}),$(".saveTree").on("click",function(){jstreeInstance.jstree("deselect_all",!0);var json=jstreeInstance.jstree("get_json"),forSave=[];$.each(json,function(index,value){value.text==value.li_attr.text&&(value.text=value.li_attr.key),forSave[index]=value;}),$("#treeValues").val(JSON.stringify(forSave)),editContainer.submit();}),$(".addNewElement").on("keydown",function(event){if(13==event.keyCode)return $(".addNewElementBtn").trigger("click"),event.preventDefault(),!1});},createTree:function createTree(){var self=this;if(!this.jstreeInstance){self.jstreeLastID=parseInt($("#treeLastID").val());var treeValues=$("#treeValues").val(),dataTree=JSON.parse(treeValues);self.jstreeInstance=$("#treeContents"),self.jstreeInstance.jstree({core:{data:dataTree,themes:{name:"proton",responsive:!0},check_callback:!0},contextmenu:{items:{create:{label:app.vtranslate("JS_JSTREE_CREATE"),action:function action(data){var treeInstance=$.jstree.reference(data.reference),selectedNode=treeInstance.get_node(data.reference);++self.jstreeLastID,treeInstance.create_node(selectedNode,{id:self.jstreeLastID,text:app.vtranslate("JS_NEW_ITEM")},"last",function(new_node){setTimeout(function(){treeInstance.edit(new_node);},0);});}},rename:{label:app.vtranslate("JS_JSTREE_RENAME"),action:function action(data){var treeInstance=$.jstree.reference(data.reference),selectedNode=treeInstance.get_node(data.reference);treeInstance.edit(selectedNode);}},changeIcon:{label:app.vtranslate("JS_JSTREE_CHANGE_ICON"),action:function action(data){var treeInstance=$.jstree.reference(data.reference),selectedNode=treeInstance.get_node(data.reference);App.Components.Icons.modalView().done(function(media){"icon"===media.type?self.jstreeInstance.jstree(!0).set_icon(selectedNode.id,media.name):"image"===media.type&&self.jstreeInstance.jstree(!0).set_icon(selectedNode.id,media.src);});}},remove:{label:app.vtranslate("JS_JSTREE_REMOVE"),action:function action(data){var treeInstance=$.jstree.reference(data.reference),id=treeInstance.get_selected(),status=!0;$.each(id,function(_index,value){var menu=treeInstance.get_node(value);0<menu.children.length&&(Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_YOU_CANNOT_DELETE_PERENT_ITEM"),type:"error"}),status=!1);}),status&&self.deleteItemEvent(id,treeInstance).done(function(e){0<e.length&&$.each(id,function(_index,value){treeInstance.delete_node(value);});});}},ccp:{label:app.vtranslate("JS_JSTREE_CCP"),submenu:{cut:{label:app.vtranslate("JS_JSTREE_CUT"),action:function action(data){var treeInstance=$.jstree.reference(data.reference),selectedNode=treeInstance.get_node(data.reference);treeInstance.is_selected(selectedNode)?treeInstance.cut(treeInstance.get_top_selected()):treeInstance.cut(selectedNode);}},paste:{label:app.vtranslate("JS_JSTREE_PASTE"),action:function action(data){var treeInstance=$.jstree.reference(data.reference),selectedNode=treeInstance.get_node(data.reference);treeInstance.paste(selectedNode);}}}}}},plugins:["contextmenu","dnd"]});}return this.jstreeInstance},deleteItemEvent:function deleteItemEvent(id,inst){var self=this,aDeferred=jQuery.Deferred(),data=inst.get_json();return ($.each(id,function(_index,e){data=self.checkChildren(e,data);}),0==data.length)?(Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_YOU_CANNOT_DELETE_ALL_THE_ITEMS"),type:"error"}),aDeferred.resolve(),aDeferred.promise()):(app.showModalWindow(null,"index.php?module=TreesManager&parent=Settings&view=ReplaceTreeItem",function(wizardContainer){var jstreeInstanceReplace=wizardContainer.find("#treePopupContents");jstreeInstanceReplace.jstree({core:{data:data,themes:{name:"proton",responsive:!0}}}).on("loaded.jstree",function(){$(this).jstree("open_all");}),wizardContainer.find(".js-modal__save").on("click",function(){var selected=jstreeInstanceReplace.jstree("get_selected"),replaceIdsElement=$("#replaceIds"),replaceIds=replaceIdsElement.val(),dataTree=[];if(""!==replaceIds&&(dataTree=JSON.parse(replaceIds)),!selected.length||1<selected.length){var message="JS_ONLY_ONE_ITEM_SELECTED";return selected.length||(message="JS_NO_ITEM_SELECTED"),Settings_Vtiger_Index_Js.showMessage({type:"error",text:app.vtranslate(message)}),!1}dataTree=$.merge(dataTree,[{old:id,new:selected}]),replaceIdsElement.val(JSON.stringify(dataTree)),app.hideModalWindow(),aDeferred.resolve(selected);});}),aDeferred.promise())},checkChildren:function checkChildren(id,data){var self=this,dataNew=[];for(var key in data)data[key].id!=id&&(data[key].children.length&&(data[key].children=self.checkChildren(id,data[key].children)),dataNew.push(data[key]));return dataNew}});
//# sourceMappingURL=Edit.min.js.map
