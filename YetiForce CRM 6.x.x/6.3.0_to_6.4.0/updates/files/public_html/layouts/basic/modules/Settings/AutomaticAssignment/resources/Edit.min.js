'use strict';

/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */"use strict";jQuery.Class("Settings_AutomaticAssignment_Edit_Js",{},{container:!1,advanceFilterInstance:!1,conditionBuilders:[],setContainer:function setContainer(container){return this.container=container,this.container},getContainer:function getContainer(){return !1==this.container&&(this.container=jQuery("div.contentsDiv form")),this.container},registerBlockToggleEvent:function registerBlockToggleEvent(){this.container.on("click",".blockHeader",function(e){var target=$(e.target);if(target.is("input")||target.is("button")||target.parents().is("button")||target.hasClass("js-stop-propagation")||target.parents().hasClass("js-stop-propagation"))return !1;var blockHeader=$(e.currentTarget),blockContents=blockHeader.next(),iconToggle=blockHeader.find(".iconToggle");blockContents.hasClass("d-none")?(blockContents.removeClass("d-none"),iconToggle.removeClass(iconToggle.data("hide")).addClass(iconToggle.data("show"))):(blockContents.addClass("d-none"),iconToggle.removeClass(iconToggle.data("show")).addClass(iconToggle.data("hide")));});},/**
		 * Register submit event
		 */registerSubmitEvent:function registerSubmitEvent(){var _this=this;this.container.off("submit").on("submit",function(e){if(e.preventDefault(),_this.container.find(".js-toggle-panel").find(".js-block-content").removeClass("d-none"),$(e.currentTarget).validationEngine("validate")){for(var key in document.progressLoader=$.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:!0}}),_this.conditionBuilders)_this.container.find("input[name=\"".concat(key,"\"]")).val(JSON.stringify(_this.conditionBuilders[key].getConditions()));_this.preSaveValidation().done(function(response){if(!0===response){var formData=_this.container.serializeFormData();app.saveAjax("save",[],formData).done(function(data){data.result&&data.result.success?(Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_SAVE_SUCCESS")}),window.location.href=data.result.url):(document.progressLoader.progressIndicator({mode:"hide"}),app.showNotify({text:app.vtranslate("JS_ERROR"),type:"error"}));}).fail(function(){document.progressLoader.progressIndicator({mode:"hide"}),app.showNotify({text:app.vtranslate("JS_ERROR"),type:"error"});});}else document.progressLoader.progressIndicator({mode:"hide"});});}return e.stopPropagation(),!1});},/**
		 * PreSave validation
		 */preSaveValidation:function preSaveValidation(){var _this2=this,aDeferred=$.Deferred(),formData=new FormData(this.container[0]);return formData.append("mode","preSaveValidation"),AppConnector.request({async:!1,url:"index.php",type:"POST",data:formData,processData:!1,contentType:!1}).done(function(data){var response=data.result;for(var i in response)!0!==response[i].result&&(app.showNotify({text:response[i].message?response[i].message:app.vtranslate("JS_ERROR"),type:"error"}),null!=response[i].hoverField&&_this2.container.find("[name=\""+response[i].hoverField+"\"]").focus());aDeferred.resolve(0>=data.result.length);}).fail(function(textStatus,errorThrown){app.showNotify({text:app.vtranslate("JS_ERROR"),type:"error"}),app.errorLog(textStatus,errorThrown),aDeferred.resolve(!1);}),aDeferred.promise()},/**
		 * Load condition builder
		 *
		 * @param   {Integer}  sourceTabId
		 */loadConditionBuilderView:function loadConditionBuilderView(sourceTabId){var _this3=this;if(!sourceTabId)return this.container.find(".js-condition-builder-container").html(""),!1;var progress=$.progressIndicator({position:"html",blockInfo:{enabled:!0}});AppConnector.request({module:app.getModuleName(),parent:app.getParentModuleName(),view:"Conditions",sourceTabId:sourceTabId}).done(function(data){progress.progressIndicator({mode:"hide"}),_this3.container.find(".js-condition-builder-container").html(data),_this3.registerConditionBuilder();});},registerConditionBuilder:function registerConditionBuilder(){var _this4=this,sourceModuleName=this.sourceModuleSelect.val();sourceModuleName&&this.container.find(".js-condition-builder").each(function(_,e){var conditionBuilder=new Vtiger_ConditionBuilder_Js($(e),sourceModuleName);conditionBuilder.registerEvents();var name=$(e).closest(".js-field-container").find(".js-condition-value").attr("name");_this4.conditionBuilders[name]=conditionBuilder;});},/**
		 * Register source module change
		 */registerSourceModuleChange:function registerSourceModuleChange(){var _this5=this;this.sourceModuleSelect=this.container.find("select[name=\"tabid\"]"),this.sourceTabId=this.sourceModuleSelect.val(),this.sourceModuleSelect.on("change",function(e){var value=$(e.currentTarget).val();_this5.sourceTabId!==value&&null!==_this5.sourceTabId&&(_this5.sourceTabId=value,_this5.loadConditionBuilderView(_this5.sourceTabId));});},registerMethodChange:function registerMethodChange(){var _this6=this;this.container.find("[name=\"method\"]").on("change",function(e){var countingCriteria=_this6.container.find("[name=\"record_limit_conditions\"]").closest(".js-field-container");1==$(e.currentTarget).val()?countingCriteria.addClass("d-none"):countingCriteria.removeClass("d-none");});},registerBasicEvents:function registerBasicEvents(){this.container.validationEngine(app.validationEngineOptionsForRecord),this.registerSubmitEvent(),this.registerBlockToggleEvent(),this.registerSourceModuleChange(),this.registerConditionBuilder();},registerEvents:function registerEvents(){this.setContainer($(".contentsDiv form")),this.registerBasicEvents(),app.showPopoverElementView(this.container.find(".js-popover-tooltip"));}});
//# sourceMappingURL=Edit.min.js.map
