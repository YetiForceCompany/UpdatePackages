'use strict';

/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */"use strict";jQuery.Class("Settings_WidgetsManagement_Js",{},{/**
		 * Function to create the array of block roles list
		 */getAuthorization:function getAuthorization(){var authorization=[],container=jQuery("#moduleBlocks");return container.find(".editFieldsTable").each(function(){authorization.push(jQuery(this).data("code").toString());}),authorization},getCurrentDashboardId:function getCurrentDashboardId(){return $(".selectDashboard li a.active").parent().data("id")},registerAddedDashboard:function registerAddedDashboard(){var thisInstance=this;$(".addDashboard").on("click",function(){app.showModalWindow({url:"index.php?parent=Settings&module="+app.getModuleName()+"&view=DashboardType",sendByAjaxCb:function sendByAjaxCb(){var contentsDiv=$(".contentsDiv");thisInstance.getModuleLayoutEditor("Home").done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});}});});},registerSelectDashboard:function registerSelectDashboard(){var thisInstance=this;$(".selectDashboard li").on("click",function(e){var contentsDiv=$(".contentsDiv");thisInstance.getModuleLayoutEditor($("#selectedModuleName").val(),$(e.currentTarget).data("id")).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});},registerDashboardAction:function registerDashboardAction(){var thisInstance=this;$(".editDashboard").on("click",function(e){var currentTarget=$(e.currentTarget);e.stopPropagation(),app.showModalWindow({url:"index.php?parent=Settings&module="+app.getModuleName()+"&view=DashboardType&dashboardId="+currentTarget.closest("li").data("id"),sendByAjaxCb:function sendByAjaxCb(){var contentsDiv=$(".contentsDiv");thisInstance.getModuleLayoutEditor("Home",currentTarget.closest("li").data("id")).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});}});}),$(".deleteDashboard").on("click",function(e){var currentTarget=$(e.currentTarget);e.stopPropagation(),AppConnector.request({parent:"Settings",module:app.getModuleName(),action:"Dashboard",mode:"delete",dashboardId:currentTarget.closest("li").data("id")}).done(function(){var contentsDiv=$(".contentsDiv");thisInstance.getModuleLayoutEditor("Home",1).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});});},/**
		 * Function to register click event for add custom block button
		 */registerAddBlockDashBoard:function registerAddBlockDashBoard(){var thisInstance=this,contents=jQuery("#layoutDashBoards");contents.find(".addBlockDashBoard").on("click",function(){var addBlockContainer=contents.find(".addBlockDashBoardModal").clone(!0,!0),inUseAuthorization=thisInstance.getAuthorization();addBlockContainer.find("select.authorized option").each(function(){-1!=jQuery.inArray(jQuery(this).val(),inUseAuthorization)&&jQuery(this).remove();});var callBackFunction=function(data){App.Fields.Picklist.changeSelectElementView(data.find("select"));var form=data.find(".addBlockDashBoardForm");form.validationEngine(app.validationEngineOptions),form.on("submit",function(e){if(form.validationEngine("validate")){var paramsForm=form.serializeFormData();delete paramsForm._csrf,thisInstance.save(paramsForm,"addBlock").done(function(data){var params={},response=data.result;response.success?(app.hideModalWindow(),params.text=app.vtranslate("JS_BLOCK_ADDED"),thisInstance.reloadContent()):(params.text=response.message,params.type="error"),Settings_Vtiger_Index_Js.showMessage(params);});}e.preventDefault();});};app.showModalWindow(addBlockContainer,function(data){"function"==typeof callBackFunction&&callBackFunction(data),App.Fields.Picklist.showSelect2ElementView(data.find(".js-authorized"));},{width:"1000px"});});},save:function save(form,mode){var params=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,aDeferred=jQuery.Deferred(),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});return params||(params={},params.form=form,params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.sourceModule=jQuery("#selectedModuleName").val(),params.action="SaveAjax",params.mode=mode),AppConnector.request(params).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),aDeferred.resolve(data);}).fail(function(error){progressIndicatorElement.progressIndicator({mode:"hide"}),aDeferred.reject(error);}),aDeferred.promise()},registerSpecialWidget:function registerSpecialWidget(){var thisInstance=this,container=jQuery("#layoutDashBoards");container.find(".addNotebook").on("click",function(){thisInstance.addNoteBookWidget(this,jQuery(this).data("url"));}),container.find(".addMiniList").on("click",function(){thisInstance.addMiniListWidget(this,jQuery(this).data("url"));}),container.find(".addRss").on("click",function(e){thisInstance.addRssWidget($(e.currentTarget),jQuery(this).data("url"));});},addRssWidget:function addRssWidget(element){var thisInstance=this,objectToShowModal={url:"index.php?module="+app.getModuleName()+"&parent="+app.getParentModuleName()+"&view=AddRss",cb:function cb(container){container.find(".removeChannel").on("click",function(e){var currentTarget=$(e.currentTarget),row=currentTarget.closest(".form-group");row.remove();}),container.find(".addChannel").on("click",function(){var newRow=container.find(".newChannel").clone(),formContainer=container.find(".formContainer");formContainer.append(newRow),newRow.removeClass("d-none"),newRow.removeClass("newChannel"),newRow.find("input").removeAttr("disabled"),newRow.find(".removeChannel").on("click",function(e){var currentTarget=$(e.currentTarget),row=currentTarget.closest(".form-group");row.remove();});}),container.find("[name=\"blockId\"]").val(element.data("blockId")),container.find("[name=\"linkId\"]").val(element.data("linkid"));var form=container.find("form");form.on("submit",function(e){e.preventDefault();var channels=[];if(form.validationEngine("validate")){form.find(".channelRss:not(:disabled)").each(function(){channels.push(jQuery(this).val());});var paramsForm=form.serializeFormData();paramsForm.channels=channels,AppConnector.request(paramsForm).done(function(data){!0===data.result&&(Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_WIDGET_ADDED")}),thisInstance.reloadContent()),app.hideModalWindow();});}});}};app.showModalWindow(objectToShowModal);},addNoteBookWidget:function addNoteBookWidget(element){var thisInstance=this;element=jQuery(element),app.showModalWindow(null,"index.php?module=Home&view=AddNotePad",function(wizardContainer){var form=jQuery("form",wizardContainer);form.validationEngine($.extend(!0,{onValidationComplete:function onValidationComplete(form,valid){if(valid){jQuery("[name='saveButton']",wizardContainer).attr("disabled","disabled");var notePadName=form.find("[name=\"notePadName\"]").val(),notePadContent=form.find("[name=\"notePadContent\"]").val(),linkId=element.data("linkid"),blockId=element.data("block-id"),noteBookParams={module:jQuery("#selectedModuleName").val(),action:"NoteBook",mode:"noteBookCreate",notePadName:notePadName,notePadContent:notePadContent,blockid:blockId,linkId:linkId,isdefault:0,width:4,height:3};AppConnector.request(noteBookParams).done(function(data){if(data.result.success){var widgetId=data.result.widgetId;app.hideModalWindow(),noteBookParams.id=widgetId,noteBookParams.label=notePadName,Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_WIDGET_ADDED")}),thisInstance.reloadContent();}});}return !1}},app.validationEngineOptions));});},addMiniListWidget:function addMiniListWidget(element,url){// 1. Show popup window for selection (module, filter, fields)
// 2. Compute the dynamic mini-list widget url
// 3. Add widget with URL to the page.
var thisInstance=this;element=$(element),app.showModalWindow(null,url,function(wizardContainer){var form=$("form",wizardContainer),moduleNameSelectDOM=$("select[name=\"module\"]",wizardContainer),filteridSelectDOM=$("select[name=\"filterid\"]",wizardContainer),fieldHrefDOM=$("select[name=\"field_href\"]",wizardContainer),fieldsSelectDOM=$("select[name=\"fields\"]",wizardContainer),filterFieldsSelectDOM=$("select[name=\"filter_fields\"]",wizardContainer),moduleNameSelect2=App.Fields.Picklist.showSelect2ElementView(moduleNameSelectDOM,{placeholder:app.vtranslate("JS_SELECT_MODULE")}),filteridSelect2=App.Fields.Picklist.showSelect2ElementView(filteridSelectDOM,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")}),fieldHrefSelect2=App.Fields.Picklist.showSelect2ElementView(fieldHrefDOM,{allowClear:!0}),fieldsSelect2=App.Fields.Picklist.showSelect2ElementView(fieldsSelectDOM,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"),closeOnSelect:!0,maximumSelectionLength:6}),filterFieldsSelect2=App.Fields.Picklist.showSelect2ElementView(filterFieldsSelectDOM,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")}),footer=$(".modal-footer",wizardContainer);filteridSelectDOM.closest("tr").hide(),fieldHrefDOM.closest("tr").hide(),fieldsSelectDOM.closest("tr").hide(),filterFieldsSelectDOM.closest("tr").hide(),footer.hide(),moduleNameSelect2.on("change",function(){moduleNameSelect2.val()&&AppConnector.request({module:"Home",view:"MiniListWizard",step:"step2",selectedModule:moduleNameSelect2.val()}).done(function(res){filteridSelectDOM.empty().html(res).trigger("change"),filteridSelect2.closest("tr").show(),fieldsSelectDOM.closest("tr").hide(),filterFieldsSelectDOM.closest("tr").hide();});}),filteridSelect2.on("change",function(){filteridSelect2.val()&&(footer.hide(),fieldsSelectDOM.closest("tr").hide(),filterFieldsSelectDOM.closest("tr").hide(),AppConnector.request({module:"Home",view:"MiniListWizard",step:"step3",selectedModule:moduleNameSelect2.val(),filterid:filteridSelect2.val()}).done(function(res){res=$(res),fieldsSelectDOM.empty().html(res.find("select[name=\"fields\"]").html()).trigger("change"),filterFieldsSelectDOM.empty().html(res.find("select[name=\"filter_fields\"]").html()).trigger("change"),fieldsSelect2.closest("tr").show(),fieldHrefSelect2.closest("tr").show(),filterFieldsSelect2.closest("tr").show(),fieldsSelect2.data("select2").$selection.find(".select2-search__field").parent().css("width","100%"),filterFieldsSelect2.data("select2").$selection.find(".select2-search__field").parent().css("width","100%");}));}),fieldsSelect2.on("change",function(){fieldHrefDOM.find("option:not([value=\"\"]").remove(),$(this).find("option:checked").each(function(index,element){var option=$(element),newOption=new Option(option.text(),option.val(),!0,!0);fieldHrefSelect2.append(newOption);}),fieldHrefSelect2.val("").trigger("change"),fieldsSelect2.val()?footer.show():footer.hide();}),form.on("submit",function(e){e.preventDefault();var selectedFields=[];fieldsSelect2.select2("data").map(function(obj){selectedFields.push(obj.id);});var data={module:moduleNameSelect2.val(),fields:selectedFields,filterFields:filterFieldsSelect2.val(),fieldHref:fieldHrefSelect2.val()},paramsForm={data:JSON.stringify(data),blockid:element.data("block-id"),title:form.find("[name=\"widgetTitle\"]").val(),linkid:element.data("linkid"),label:moduleNameSelect2.find(":selected").text()+" - "+filteridSelect2.find(":selected").text(),name:"Mini List",filterid:filteridSelect2.val(),isdefault:0,cache:0,height:4,width:4,owners_all:["mine","all","users","groups"],default_owner:"mine"},sourceModule=$("[name=\"widgetsManagementEditorModules\"]").val(),baseParams={form:paramsForm,module:sourceModule,sourceModule:sourceModule,action:"Widget",mode:"add",addToUser:!1,linkid:paramsForm.linkid,name:paramsForm.name};thisInstance.save(paramsForm,"save",baseParams).done(function(data){var result=data.result,params={};if(data.success)app.hideModalWindow(),paramsForm.id=result.id,paramsForm.status=result.status,params.text=app.vtranslate("JS_WIDGET_ADDED"),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.reloadContent();else {var errorField,message=data.error.message;errorField=513===data.error.code?form.find("[name=\"fieldLabel\"]"):form.find("[name=\"fieldName\"]"),errorField.validationEngine("showPrompt",message,"error","topLeft",!0);}});});});},/**
		 * Reload content
		 */reloadContent:function reloadContent(){$(".selectDashboard .nav-link.active").trigger("click");},/**
		 * Function to register the click event for delete custom block
		 */registerDeleteCustomBlockEvent:function registerDeleteCustomBlockEvent(){var thisInstance=this,contents=jQuery("#layoutDashBoards");contents.on("click",".js-delete-custom-block-btn",function(e){var currentTarget=jQuery(e.currentTarget),table=currentTarget.closest("div.editFieldsTable"),blockId=table.data("block-id"),paramsFrom={};paramsFrom.blockid=blockId,app.showConfirmModal({title:app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE"),confirmedCallback:function confirmedCallback(){thisInstance.save(paramsFrom,"removeBlock").done(function(){thisInstance.reloadContent(),Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_CUSTOM_BLOCK_DELETED")});});}});});},/**
		 * Function to register the change event for layout editor modules list
		 */registerModulesChangeEvent:function registerModulesChangeEvent(){var thisInstance=this,container=$("#widgetsManagementEditorContainer"),contentsDiv=container.closest(".contentsDiv");App.Fields.Picklist.changeSelectElementView(container.find("[name=\"widgetsManagementEditorModules\"]")),container.on("change","[name=\"widgetsManagementEditorModules\"]",function(e){thisInstance.getModuleLayoutEditor($(e.currentTarget).val(),thisInstance.getCurrentDashboardId()).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});},/**
		 * Update contents div and register events.
		 * @param {jQuery} contentsDiv
		 * @param {HTMLElement} data
		 */updateContentsDiv:function updateContentsDiv(contentsDiv,data){contentsDiv.html(data),App.Fields.Picklist.showSelect2ElementView(contentsDiv.find(".select2")),this.registerEvents();},/**
		 * Function to get the respective module layout editor through pjax
		 */getModuleLayoutEditor:function getModuleLayoutEditor(selectedModule,selectedDashboard){var aDeferred=jQuery.Deferred(),progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),params={};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.view="Configuration",params.sourceModule=selectedModule,params.dashboardId=selectedDashboard,AppConnector.requestPjax(params).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),aDeferred.resolve(data);}).fail(function(){progressIndicatorElement.progressIndicator({mode:"hide"}),aDeferred.reject();}),aDeferred.promise()},/**
		 * Function to register the click event for delete widget
		 */registerDeleteWidgetEvent:function registerDeleteWidgetEvent(contents){var _this=this;"undefined"==typeof contents&&(contents=jQuery("#layoutDashBoards")),contents.find(".js-delete-widget").on("click",function(e){var widgetId=e.currentTarget.dataset.id;app.showConfirmModal({title:app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE"),confirmedCallback:function confirmedCallback(){var progress=$.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:!0}});app.saveAjax("delete",null,{widgetId:widgetId}).done(function(data){!0===data.result&&Settings_Vtiger_Index_Js.showMessage({type:"success",text:app.vtranslate("JS_CUSTOM_FIELD_DELETED")}),progress.progressIndicator({mode:"hide"}),_this.reloadContent();});}});});},registerWidgetEvent:function registerWidgetEvent(){var _this2=this,contents=$("#layoutDashBoards");contents.find(".js-edit-widget").on("click",function(e){var url=e.currentTarget.dataset.url;_this2.addWidget(url);}),contents.find(".js-add-widget").on("click",function(e){var url=e.currentTarget.dataset.url;return !!url&&void app.showModalWindow({url:url,cb:function cb(modalContainer){modalContainer.on("click",".js-modal__save",function(){var selectedOption=modalContainer.find(".js-widget").val();selectedOption&&_this2.addWidget(selectedOption);});}})}),this.registerDeleteWidgetEvent(contents);},addWidget:function addWidget(url){var _this3=this;app.showModalWindow({url:url,cb:function cb(container){app.showPopoverElementView(container.find(".js-popover-tooltip"));},sendByAjaxCb:function sendByAjaxCb(_,response){!0===response.result&&(Settings_Vtiger_Index_Js.showMessage({type:"success",text:app.vtranslate("JS_WIDGET_ADDED")}),_this3.reloadContent());}});},/**
		 * register events for layout editor
		 */registerEvents:function registerEvents(){this.registerAddBlockDashBoard(),this.registerWidgetEvent(),this.registerSpecialWidget(),this.registerDeleteCustomBlockEvent(),this.registerModulesChangeEvent(),this.registerAddedDashboard(),this.registerSelectDashboard(),this.registerDashboardAction();}}),$(function(){var instance=new Settings_WidgetsManagement_Js;instance.registerEvents();});
//# sourceMappingURL=WidgetsManagement.min.js.map
