'use strict';

/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */"use strict";jQuery.Class("Vtiger_TreeCategory_Js",{},{modalContainer:!1,treeInstance:!1,treeData:!1,windowParent:app.getWindowParent(),getModalContainer:function getModalContainer(){return !1==this.modalContainer&&(this.modalContainer=jQuery("#modalTreeCategoryModal")),this.modalContainer},getRecords:function getRecords(container){if(!1==this.treeData&&"undefined"!==container){var treeValues=container.find("#treePopupValues").val();this.treeData=JSON.parse(treeValues);}return this.treeData},generateTree:function generateTree(container){var thisInstance=this;if(!1==thisInstance.treeInstance){thisInstance.treeInstance=container.find("#treePopupContents");var plugins=["search","category"];"2"==thisInstance.getRelationType()&&plugins.push("checkbox"),"1"==thisInstance.getRelationType()&&plugins.push("edit"),thisInstance.treeInstance.jstree($.extend(!0,{core:{data:thisInstance.getRecords(),themes:{name:"proton",responsive:!0}},checkbox:{three_state:!1},plugins:plugins},thisInstance.treeInstance.data("params")));}},getRelationType:function getRelationType(){return this.getModalContainer().find("#relationType").val()},searching:function searching(text){this.treeInstance.jstree(!0).search(text);},registerSearchEvent:function registerSearchEvent(){var thisInstance=this,valueSearch=$("#valueSearchTree"),btnSearch=$("#btnSearchTree");valueSearch.on("keypress",function(e){13==e.which&&thisInstance.searching(valueSearch.val());}),btnSearch.on("click",function(){thisInstance.searching(valueSearch.val());});},registerSaveRecords:function registerSaveRecords(container){var thisInstance=this,ord=[],ocd=[];$.each(thisInstance.getRecords(),function(index,value){value.state&&value.state.selected&&"record"===value.attr&&ord.push(value.record_id),value.category&&value.category.checked&&"record"!==value.attr&&ocd.push(value.record_id);}),container.find("[name=\"saveButton\"]").on("click",function(){var recordsToAdd=[],categoryToAdd=[],recordsToRemove=Object.assign([],ord),categoryToRemove=Object.assign([],ocd),saveButton=$(this);saveButton.attr("disabled","disabled");var cSelected=thisInstance.treeInstance.jstree("getCategory",!0);$.each(cSelected,function(index,treeElement){var value=treeElement.record_id;"record"===treeElement.attr?-1==jQuery.inArray(value,recordsToRemove)?recordsToAdd.push(value):recordsToRemove.splice(recordsToRemove.indexOf(value),1):"record"!==treeElement.attr&&(-1==jQuery.inArray(value,categoryToRemove)?categoryToAdd.push(value):categoryToRemove.splice(categoryToRemove.indexOf(value),1));});var params={module:thisInstance.windowParent.app.getModuleName(),action:"RelationAjax",mode:"updateRelation",recordsToAdd:recordsToAdd,recordsToRemove:recordsToRemove,categoryToAdd:categoryToAdd,categoryToRemove:categoryToRemove,src_record:thisInstance.windowParent.app.getRecordId(),related_module:container.find("#relatedModule").val()};4<recordsToAdd.length?app.showConfirmModal({title:app.vtranslate("JS_INFORMATION"),text:app.vtranslate("JS_SAVE_SELECTED_ITEMS_ALERT").replace("__LENGTH__",recordsToAdd.length),confirmedCallback:function confirmedCallback(){thisInstance.saveRecordsEvent(params);},rejectedCallback:function rejectedCallback(){saveButton.removeAttr("disabled");}}):thisInstance.saveRecordsEvent(params);});},saveRecordsEvent:function saveRecordsEvent(params){var self=this;AppConnector.request(params).done(function(){self.windowParent.Vtiger_Detail_Js.getInstance().reloadTabContent(),app.hideModalWindow();});},registerCounterSelected:function registerCounterSelected(){var thisInstance=this;this.treeInstance.on("changed.jstree",function(){var counterSelected=0,html="";$.each(thisInstance.treeInstance.jstree("get_selected",!0),function(index,value){var id=value.original.record_id.toString();id.indexOf("T")&&counterSelected++;}),html=app.vtranslate("JS_SELECTED_ELEMENTS")+": "+counterSelected,$(".counterSelected").text(html);});},registerEvents:function registerEvents(){var container=this.getModalContainer();this.getRecords(container),this.generateTree(container),this.registerSaveRecords(container),this.registerSearchEvent(),this.registerCounterSelected();}}),jQuery(function(){var instance=new Vtiger_TreeCategory_Js;instance.registerEvents();});
//# sourceMappingURL=TreeCategoryModal.min.js.map
