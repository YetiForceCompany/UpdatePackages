'use strict';

/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */"use strict";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})),keys.push.apply(keys,symbols);}return keys}function _objectSpread(target){for(var source,i=1;i<arguments.length;i++)source=null==arguments[i]?{}:arguments[i],i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});return target}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor);}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}window.Settings_PickListDependency_Edit_Js=/*#__PURE__*/function(){function _class2(){_classCallCheck(this,_class2),_defineProperty(this,"conditionBuilders",[]);}return _createClass(_class2,[{key:"getProgressIndicator",value:/**
	 * Get progress inducator element
	 * @param {jQuery} block
	 * @returns
	 */function getProgressIndicator(block){var params={position:"html",blockInfo:{enabled:!0}};return "undefined"!=typeof block&&(params.blockInfo.elementToBlock=block),$.progressIndicator(params)}/**
	 * Register basic events
	 */},{key:"registerBasicEvents",value:function registerBasicEvents(){var _this=this;this.container.on("change","select[name=\"tabid\"]",function(e){e.currentTarget.value?_this.getView(_objectSpread({mode:"dependentFields"},_this.getDefaultParams())).done(function(data){_this.fieldsContainer.html(data),_this.moduleField=_this.fieldsContainer.find("select[name=\"tabid\"]"),App.Fields.Picklist.showSelect2ElementView(_this.fieldsContainer.find("select")),_this.graphContainer.html("");}):(_this.fieldsContainer.html(""),_this.graphContainer.html(""));}),this.fieldsContainer.on("change","select[name=\"source_field\"]",function(){_this.graphContainer.html(""),_this.validate(form).done(function(){_this.getView(_objectSpread(_objectSpread({mode:"getDependencyGraph"},_this.getDefaultParams()),_this.form.serializeFormData())).done(function(data){_this.graphContainer.html(data),App.Fields.Picklist.showSelect2ElementView(_this.graphContainer.find("select")),_this.registerConditionBuilder();});});}),this.container.on("click",".js-pd-save",function(){for(var key in _this.conditionBuilders)_this.container.find("input[name=\"".concat(key,"\"]")).val(JSON.stringify(_this.conditionBuilders[key].getConditions()));_this.validate(form).done(function(){_this.saveAjax(_objectSpread({mode:"save"},_this.form.serializeFormData()));});});}/**
	 * Validate
	 * @returns bool
	 */},{key:"validate",value:function validate(){var aDeferred=$.Deferred(),result=this.form.validationEngine("validate");return result?this.saveAjax(_objectSpread(_objectSpread({mode:"preSaveValidation"},this.getDefaultParams()),this.form.serializeFormData())).done(function(response){var errors=response.result;for(var i in errors)!0!==errors[i].result&&app.showNotify({text:errors[i].message?errors[i].message:app.vtranslate("JS_ERROR"),type:"error",delay:3e3,hide:!0});0>=errors.length?aDeferred.resolve(!0):aDeferred.reject(!1);}).fail(function(response){aDeferred.reject(response);}):aDeferred.reject(result),aDeferred.promise()}/**
	 * Save data
	 * @param {Object} formData
	 */},{key:"saveAjax",value:function saveAjax(formData){var progress=this.getProgressIndicator(),aDeferred=$.Deferred();return app.saveAjax("",[],formData).done(function(response){response&&"string"==typeof response&&(response=JSON.parse(response)),response.result&&response.result.url&&(window.location.href=response.result.url),progress.progressIndicator({mode:"hide"}),aDeferred.resolve(response);}).fail(function(error){app.showNotify({text:app.vtranslate("JS_ERROR"),type:"error"}),progress.progressIndicator({mode:"hide"}),aDeferred.reject(error);}),aDeferred.promise()}/**
	 * Get default params
	 * @returns {Object}
	 */},{key:"getDefaultParams",value:function getDefaultParams(){return {module:app.getModuleName(),parent:app.getParentModuleName(),view:"IndexAjax",tabid:this.moduleField.val()}}/**
	 * Get view
	 * @param {Objcet} params
	 * @returns html
	 */},{key:"getView",value:function getView(params){var aDeferred=$.Deferred(),progressIndicatorElement=$.progressIndicator({position:"html",blockInfo:{enabled:!0}});return AppConnector.request(params).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"}),aDeferred.resolve(data);}).fail(function(error){progressIndicatorElement.progressIndicator({mode:"hide"}),app.showNotify({text:app.vtranslate("JS_ERROR"),type:"error"}),aDeferred.reject(error);}),aDeferred.promise()}/**
	 * Register condition builder
	 */},{key:"registerConditionBuilder",value:function registerConditionBuilder(){var _this2=this,sourceModuleName=this.moduleField.val();if(sourceModuleName){var sourceField=this.fieldsContainer.find("[name=\"source_field\"]").val();this.container.find(".js-condition-builder").each(function(_,e){var conditionBuilder=new Vtiger_ConditionBuilder_Js($(e),{sourceModuleName:sourceModuleName,sourceField:sourceField});conditionBuilder.registerEvents();var name=$(e).closest(".js-field-container").find(".js-condition-value").attr("name");_this2.conditionBuilders[name]=conditionBuilder;});}}/**
	 * Register toggle block
	 */},{key:"registerBlockToggleEvent",value:function registerBlockToggleEvent(){this.container.on("click",".blockHeader",function(e){var target=$(e.target);if(target.is("input")||target.is("button")||target.parents().is("button")||target.hasClass("js-stop-propagation")||target.parents().hasClass("js-stop-propagation"))return !1;var blockHeader=$(e.currentTarget),blockContents=blockHeader.next(),iconToggle=blockHeader.find(".iconToggle");blockContents.hasClass("d-none")?(blockContents.removeClass("d-none"),iconToggle.removeClass(iconToggle.data("hide")).addClass(iconToggle.data("show"))):(blockContents.addClass("d-none"),iconToggle.removeClass(iconToggle.data("show")).addClass(iconToggle.data("hide")));});}/**
	 * Register events
	 */},{key:"registerEvents",value:function registerEvents(){this.container=$(".js-picklist-dependent-container"),this.form=this.container.find("form"),this.moduleField=this.container.find("select[name=\"tabid\"]"),this.fieldsContainer=this.container.find(".js-dependent-fields"),this.graphContainer=this.container.find(".js-dependency-tables-container"),this.form.validationEngine(app.validationEngineOptions),this.registerBasicEvents(),this.registerConditionBuilder(),this.registerBlockToggleEvent();}}]),_class2}();
//# sourceMappingURL=Edit.min.js.map
