{"version":3,"file":"Edit.min.js","sources":["Edit.js"],"sourcesContent":["/* {[The file is published on the basis of YetiForce Public License 6.5 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n'use strict';\n\nVtiger_Edit_Js(\n\t'HelpDesk_Edit_Js',\n\t{},\n\t{\n\t\t/**\n\t\t * Register pre save event\n\t\t * @param {jQuery} form\n\t\t */\n\t\tregisterRecordPreSaveEventEvent: function (form) {\n\t\t\tthis._super(form);\n\t\t\tform.on(Vtiger_Edit_Js.recordPreSave, (e, data) => {\n\t\t\t\ttry {\n\t\t\t\t\tthis.validateToClose(form).done((response) => {\n\t\t\t\t\t\tif (response !== true) {\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} catch (error) {\n\t\t\t\t\tapp.errorLog(error);\n\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\ttext: app.vtranslate('JS_ERROR'),\n\t\t\t\t\t\ttype: 'error'\n\t\t\t\t\t});\n\t\t\t\t\te.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tvalidateToClose: function (form) {\n\t\t\tconst aDeferred = $.Deferred();\n\t\t\tlet closedStatus = app.getMainParams('closeTicketForStatus', true);\n\t\t\tlet status = form.find('[name=\"ticketstatus\"] :selected').val();\n\t\t\tlet progress = $.progressIndicator({ position: 'html', blockInfo: { enabled: true } });\n\t\t\tlet isClosedStatusSet = status in closedStatus;\n\t\t\tconst recordId = form.find('[name=\"record\"]').val();\n\t\t\tif (\n\t\t\t\t(app.getMainParams('checkIfRecordHasTimeControl') || app.getMainParams('checkIfRelatedTicketsAreClosed')) &&\n\t\t\t\tisClosedStatusSet &&\n\t\t\t\trecordId\n\t\t\t) {\n\t\t\t\tlet formData = {\n\t\t\t\t\taction: 'CheckValidateToClose',\n\t\t\t\t\tmodule: app.getModuleName(),\n\t\t\t\t\trecord: recordId,\n\t\t\t\t\tstatus: form.find('[name=\"ticketstatus\"] :selected').val()\n\t\t\t\t};\n\t\t\t\tAppConnector.request({\n\t\t\t\t\tasync: false,\n\t\t\t\t\turl: 'index.php',\n\t\t\t\t\ttype: 'POST',\n\t\t\t\t\tdata: formData\n\t\t\t\t}).done((response) => {\n\t\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\t\tif (response.result.hasTimeControl.result && response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\taDeferred.resolve(true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (!response.result.hasTimeControl.result) {\n\t\t\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\t\t\ttext: response.result.hasTimeControl.message,\n\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tthis.addTimeControl({\n\t\t\t\t\t\t\t\trecordId: recordId,\n\t\t\t\t\t\t\t\turl: `index.php?module=OSSTimeControl&view=Edit&sourceModule=HelpDesk&sourceRecord=${recordId}&relationOperation=true&subprocess=${recordId}&subprocess=${recordId}`\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!response.result.relatedTicketsClosed.result) {\n\t\t\t\t\t\t\tapp.showNotify({\n\t\t\t\t\t\t\t\ttext: response.result.relatedTicketsClosed.message,\n\t\t\t\t\t\t\t\ttype: 'info'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\taDeferred.resolve(false);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (isClosedStatusSet && !recordId) {\n\t\t\t\tapp.showNotify({\n\t\t\t\t\ttext: app.vtranslate('JS_CANT_CLOSE_NEW_RECROD'),\n\t\t\t\t\ttype: 'info'\n\t\t\t\t});\n\t\t\t\tprogress.progressIndicator({ mode: 'hide' });\n\t\t\t\taDeferred.resolve(false);\n\t\t\t} else {\n\t\t\t\taDeferred.resolve(true);\n\t\t\t}\n\n\t\t\treturn aDeferred.promise();\n\t\t},\n\t\t/**\n\t\t * Add time control when closed ticket\n\t\t * @param {array} params\n\t\t * @returns {Promise}\n\t\t */\n\t\taddTimeControl: function (params) {\n\t\t\tlet aDeferred = jQuery.Deferred();\n\t\t\tlet referenceModuleName = 'OSSTimeControl';\n\t\t\tlet parentId = params.recordId;\n\t\t\tlet parentModule = 'HelpDesk';\n\t\t\tlet quickCreateParams = {};\n\t\t\tlet relatedParams = {};\n\t\t\tlet relatedField = 'subprocess';\n\t\t\tlet fullFormUrl = params.url;\n\t\t\trelatedParams[relatedField] = parentId;\n\t\t\tlet eliminatedKeys = new Array('view', 'module', 'mode', 'action');\n\n\t\t\tlet preQuickCreateSave = function (data) {\n\t\t\t\tlet index, queryParam, queryParamComponents;\n\t\t\t\tlet queryParameters = [];\n\n\t\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\t\tqueryParameters = queryString.split('&');\n\t\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\t\tif (queryParamComponents[0] == 'mode' && queryParamComponents[1] == 'Calendar') {\n\t\t\t\t\t\t\tdata.find('a[data-tab-name=\"Task\"]').trigger('click');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceModule\" value=\"' + parentModule + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"sourceRecord\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\tjQuery('<input type=\"hidden\" name=\"relationOperation\" value=\"true\" />').appendTo(data);\n\n\t\t\t\tif (typeof relatedField !== 'undefined') {\n\t\t\t\t\tlet field = data.find('[name=\"' + relatedField + '\"]');\n\t\t\t\t\tif (field.length == 0) {\n\t\t\t\t\t\tjQuery('<input type=\"hidden\" name=\"' + relatedField + '\" value=\"' + parentId + '\" />').appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tfor (index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tqueryParam = queryParameters[index];\n\t\t\t\t\tqueryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (\n\t\t\t\t\t\tjQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1' &&\n\t\t\t\t\t\tdata.find('[name=\"' + queryParamComponents[0] + '\"]').length == 0\n\t\t\t\t\t) {\n\t\t\t\t\t\tjQuery(\n\t\t\t\t\t\t\t'<input type=\"hidden\" name=\"' + queryParamComponents[0] + '\" value=\"' + queryParamComponents[1] + '\" />'\n\t\t\t\t\t\t).appendTo(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (typeof fullFormUrl !== 'undefined' && fullFormUrl.indexOf('?') !== -1) {\n\t\t\t\tlet urlSplit = fullFormUrl.split('?');\n\t\t\t\tlet queryString = urlSplit[1];\n\t\t\t\tlet queryParameters = queryString.split('&');\n\t\t\t\tfor (let index = 0; index < queryParameters.length; index++) {\n\t\t\t\t\tlet queryParam = queryParameters[index];\n\t\t\t\t\tlet queryParamComponents = queryParam.split('=');\n\t\t\t\t\tif (jQuery.inArray(queryParamComponents[0], eliminatedKeys) == '-1') {\n\t\t\t\t\t\trelatedParams[queryParamComponents[0]] = queryParamComponents[1];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tquickCreateParams['data'] = relatedParams;\n\t\t\tquickCreateParams['callbackFunction'] = function () {};\n\t\t\tquickCreateParams['callbackPostShown'] = preQuickCreateSave;\n\t\t\tquickCreateParams['noCache'] = true;\n\t\t\tApp.Components.QuickCreate.createRecord(referenceModuleName, quickCreateParams);\n\t\t\treturn aDeferred.promise();\n\t\t}\n\t}\n);\n"],"names":["Vtiger_Edit_Js","registerRecordPreSaveEventEvent","form","_this","_super","on","recordPreSave","e","validateToClose","done","response","preventDefault","error","app","errorLog","showNotify","text","vtranslate","type","_this2","aDeferred","$","Deferred","closedStatus","getMainParams","status","find","val","progress","progressIndicator","position","blockInfo","enabled","isClosedStatusSet","recordId","formData","action","module","getModuleName","record","AppConnector","request","async","url","data","mode","result","hasTimeControl","relatedTicketsClosed","resolve","message","addTimeControl","concat","promise","params","jQuery","parentId","quickCreateParams","relatedParams","relatedField","fullFormUrl","eliminatedKeys","Array","preQuickCreateSave","index","queryParam","queryParamComponents","queryParameters","indexOf","urlSplit","split","queryString","length","trigger","appendTo","field","inArray","callbackFunction","callbackPostShown","noCache","App","Components","QuickCreate","createRecord"],"mappings":"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"}