'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) {
  return typeof obj;
} : function (obj) {
  return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
};

jQuery.Class('Settings_Widgets_Index_Js',{},{getTabId:function getTabId(){return $('.WidgetsManage [name=\'tabid\']').val()},getType:function getType(){return $('.form-modalAddWidget [name=\'type\']').val()},createStep2:function createStep2(type){var thisInstance=this,tabId=thisInstance.getTabId(),progressIndicatorElement=jQuery.progressIndicator({position:'html'});app.showModalWindow(null,'index.php?parent=Settings&module=Widgets&view=Widget&mode=createStep2&type='+type+'&tabId='+tabId,function(wizardContainer){app.showPopoverElementView(wizardContainer.find('.js-help-info')),('RelatedModule'===type||'RelatedModuleChart'===type||'Documents'===type)&&(thisInstance.loadFilters(wizardContainer),thisInstance.relatedModuleFields(wizardContainer),thisInstance.customView(wizardContainer),wizardContainer.find('select[name=\'relation_id\']').on('change',function(){thisInstance.changeRelatedModule(wizardContainer),thisInstance.relatedModuleFields(wizardContainer),thisInstance.customView(wizardContainer);})),thisInstance.registerSort(wizardContainer),progressIndicatorElement.progressIndicator({mode:'hide'});var form=jQuery('form',wizardContainer);form.validationEngine(app.validationEngineOptions),form.on('submit',function(e){if(e.preventDefault(),form.validationEngine('validate')){var save=!0;form&&form.hasClass('validateForm')&&0<form.data('jqv').InvalidFields.length&&(app.formAlignmentAfterValidation(form),save=!1),save&&thisInstance.registerSaveEvent('saveWidget',{data:form.serializeFormData(),tabid:tabId}).done(function(){thisInstance.reloadWidgets(),app.hideModalWindow();});}});});},loadWidgets:function loadWidgets(){var thisInstance=this,blocks=jQuery('.blocksSortable');blocks.sortable({revert:!0,connectWith:'.blocksSortable',tolerance:'pointer',cursor:'move',placeholder:'state-highlight',stop:function stop(){thisInstance.updateSequence();}});},updateSequence:function updateSequence(){var thisInstance=this,params={};$('.blockSortable').each(function(index){params[$(this).data('id')]={index:index,column:$(this).closest('.blocksSortable').data('column')};});var progress=$.progressIndicator({message:app.vtranslate('Saving changes'),blockInfo:{enabled:!0}});thisInstance.registerSaveEvent('updateSequence',{data:params,tabid:$('input[name=\'tabid\']').val()}),progress.progressIndicator({mode:'hide'});},reloadWidgets:function reloadWidgets(){var thisInstance=this,Indicator=jQuery.progressIndicator({message:app.vtranslate('Loading data'),position:'html',blockInfo:{enabled:!0}}),params={};params.module='Widgets',params.view='Index',params.parent='Settings',params.source=$('input[name=\'tabid\']').val(),AppConnector.request(params).done(function(data){var container=jQuery('div.contentsDiv').html(data);thisInstance.registerEvents(container),Indicator.progressIndicator({mode:'hide'});});},registerSaveEvent:function registerSaveEvent(mode,data){var aDeferred=$.Deferred();return AppConnector.request({module:app.getModuleName(),parent:app.getParentModuleName(),action:'SaveAjax',mode:mode,params:data,async:'saveWidget'!==mode,dataType:'json'}).done(function(data){aDeferred.resolve(data),app.showNotify({text:data.result.message,type:'success'});}).fail(function(textStatus,errorThrown){aDeferred.reject(textStatus,errorThrown);}),aDeferred.promise()},loadFilters:function loadFilters(contener){var types=['filter','checkbox','switchHeader'],selected=contener.find('select[name=\'relation_id\'] option:selected'),relatedModuleInput=contener.find('input[name=\'relatedmodule\']'),relatedModule=relatedModuleInput.val();selected.length&&(relatedModule=selected.data('relatedmodule'),relatedModuleInput.val(selected.data('relatedmodule')).data('module-name',selected.data('module-name')));var _loop=function(i){var filters=app.getMainParams(types[i]+'All',!0),filterField=contener.find('select[name=\''+types[i]+'\']'),filterSelected=contener.find('input#'+types[i]+'_selected').val();filterField.empty(),filterField.append($('<option/>',{value:'-',text:app.vtranslate('None')})),filters[relatedModule]===void 0?filterField.closest('.form-group').addClass('d-none'):(filterField.closest('.form-group').removeClass('d-none'),$.each(filters[relatedModule],function(index,value){'object'===('undefined'==typeof value?'undefined':_typeof(value))&&(value=value.label);var option={value:index,text:value};filterSelected==index&&(option.selected='selected'),filterField.append($('<option/>',option));}),App.Fields.Picklist.showSelect2ElementView(filterField));};for(var i in types)_loop(i);},relatedModuleFields:function relatedModuleFields(container){var relatedModule=parseInt(container.find('input[name=\'relatedmodule\']').val()),relatedfields=container.find('select[name=\'relatedfields\'],select[name=\'groupField\']');relatedfields.find('optgroup').each(function(index,optgroup){optgroup=$(optgroup),relatedModule===optgroup.data('module')?(optgroup.removeClass('d-none'),optgroup.prop('disabled',!1)):(optgroup.addClass('d-none'),optgroup.prop('disabled','disabled')),optgroup.find('option').each(function(index,option){option=$(option),relatedModule===option.data('module')?(option.removeClass('d-none'),option.prop('disabled',!1)):(option.addClass('d-none').removeAttr('selected'),option.prop('disabled','disabled'));});}),relatedfields.trigger('change:select2');},changeRelatedModule:function changeRelatedModule(wizardContainer){this.loadFilters(wizardContainer.find('.form-modalAddWidget'));},customView:function(container){var relatedModule=parseInt(container.find('input[name=\'relatedmodule\']').val()),customViews=app.getMainParams('customView',!0),customView=container.find('select[name=\'customView\']'),customViewValues=container.find('.js-custom-view').val();customViewValues=customViewValues?JSON.parse(customViewValues):[],customView.empty(),customViews[relatedModule]!==void 0&&$.each(customViews[relatedModule],function(index,value){var option={value:index,text:value};customViewValues.includes(index)&&(option.selected='selected'),customView.append($('<option/>',option));}),customView.trigger('change:select2');},modalFormEdit:function modalFormEdit(wizardContainer){var thisInstance=this;$('#massEditHeader.modal-title').text(app.vtranslate('JS_EDIT_WIDGET')),app.showPopoverElementView(wizardContainer.find('.js-help-info'));var type=thisInstance.getType();('RelatedModule'==type||'RelatedModuleChart'===type||'Documents'===type)&&(thisInstance.loadFilters(wizardContainer),thisInstance.relatedModuleFields(wizardContainer),thisInstance.customView(wizardContainer),wizardContainer.find('select[name=\'relation_id\']').on('change',function(){thisInstance.changeRelatedModule(wizardContainer),thisInstance.relatedModuleFields(wizardContainer),thisInstance.customView(wizardContainer);})),this.registerSort(wizardContainer);var form=$('form',wizardContainer);form.validationEngine(app.validationEngineOptions),form.on('submit',function(e){if(e.preventDefault(),form.validationEngine('validate')){var progress=$.progressIndicator({message:app.vtranslate('Loading data'),blockInfo:{enabled:!0}});thisInstance.registerSaveEvent('saveWidget',{data:form.serializeFormData(),tabid:$('input[name=\'tabid\']').val()}).done(function(){thisInstance.reloadWidgets(),app.hideModalWindow(),progress.progressIndicator({mode:'hide'});});}});},registerSort:function registerSort(container){container.find('select[name=\'relation_id\']').on('change',function(){container.find('#orderBy').val('[]');}),container.find('.js-sort-modal').on('click',function(e){var relatedModule=container.find('input[name=\'relatedmodule\']').data('module-name'),url=e.currentTarget.dataset.url;app.showModalWindow(null,url+'&module='+relatedModule,function(wizardContainer){wizardContainer.find('.js-modal__save').on('click',function(el){el.preventDefault();var sortData={};wizardContainer.find('.js-sort-container_element:not(.js-base-element)').each(function(){var orderBy=$(this).find('.js-orderBy').val();orderBy&&(sortData[orderBy]=$(this).find('.js-sort-order').val());}),container.find('#orderBy').val(JSON.stringify(sortData));});},{modalId:e.currentTarget.dataset.modalid});});},registerEvents:function registerEvents(container){var _this=this,thisInstance=this;this.loadWidgets(),'undefined'==typeof container&&(container=jQuery('.WidgetsManage')),App.Fields.Picklist.showSelect2ElementView(container.find('.select2')),container.find('select.js-module__list').on('change',function(e){var target=$(e.currentTarget);$('input[name=\'tabid\']').val(target.val()),thisInstance.reloadWidgets();}),container.find('.js-widget__add').on('click',function(){var progressIndicatorElement=jQuery.progressIndicator({position:'html'}),module=$('.WidgetsManage select.js-module__list').val();app.showModalWindow(null,'index.php?parent=Settings&module=Widgets&view=Widget&mod='+module,function(wizardContainer){progressIndicatorElement.progressIndicator({mode:'hide'});var form=jQuery('form',wizardContainer);form.on('submit',function(e){e.preventDefault();var type=form.find('[name="type"]').val();thisInstance.createStep2(type);});});}),container.find('.js-widget__edit').on('click',function(e){app.showModalWindow({url:'index.php?parent=Settings&module=Widgets&view=Widget&mode=edit&id='+$(e.currentTarget).closest('.blockSortable').data('id'),cb:function cb(wizardContainer){_this.modalFormEdit(wizardContainer);}});}),container.find('.js-widget__remove').on('click',function(e){var target=$(e.currentTarget),blockSortable=target.closest('.blockSortable');thisInstance.registerSaveEvent('removeWidget',{wid:blockSortable.data('id')}),thisInstance.reloadWidgets();});}});
//# sourceMappingURL=Widgets.min.js.map
