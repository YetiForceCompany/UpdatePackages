'use strict';

$.Class('Base_ChartFilter_JS',{},{/**
		 * Widget type name
		 */widgetName:'ChartFilter',registerContainers:function registerContainers(){this.step1=$('.step1',this.container),this.step2=$('.step2',this.container),this.step3=$('.step3',this.container),this.step4=$('.step4',this.container),this.footer=$('.js-chart-footer',this.container),this.form=$('form',this.container),this.stepNumber=$('#widgetStep',this.container);},/**
		 * Register first step elements
		 */registerStep1:function registerStep1(){var _this=this,chartType=$('select[name="chartType"]',this.container),moduleElement=$('select[name="module"]',this.container);App.Fields.Picklist.showSelect2ElementView(moduleElement,{placeholder:app.vtranslate('JS_SELECT_MODULE')}),this.moduleName=moduleElement.val(),this.chartTypeValue=chartType.val(),chartType.on('change',function(e){_this.chartTypeValue=e.currentTarget.value,moduleElement.trigger('change');}),moduleElement.on('change',function(e){return _this.moduleName=e.currentTarget.value,!!_this.moduleName&&void(_this.footer.hide(),_this.step2.empty(),_this.step3.empty(),_this.step4.empty(),AppConnector.request({module:_this.sourceModuleName,view:_this.widgetName,step:'step2',chartType:_this.chartTypeValue,selectedModule:_this.moduleName}).done(function(data){_this.registerStep2(data);}))});},/**
		 * Register second step elements
		 */registerStep2:function registerStep2(stepContainer){var _this2=this;this.step2.append(stepContainer),this.stepNumber.val(2),this.footer.hide();var filtersIdElement=this.step2.find('.filtersId'),valueTypeElement=this.step2.find('.valueType');App.Fields.Picklist.showSelect2ElementView(filtersIdElement),App.Fields.Picklist.showSelect2ElementView(valueTypeElement),this.step2.find('.filtersId, .valueType').on('change',function(){_this2.step3.empty(),_this2.step4.empty(),_this2.footer.hide();var filterId=filtersIdElement.val(),type=valueTypeElement.val();filterId&&0!==Object.keys(filterId).length&&type&&0!==Object.keys(type).length&&AppConnector.request({module:_this2.sourceModuleName,view:_this2.widgetName,step:'step3',selectedModule:_this2.moduleName,chartType:_this2.chartTypeValue,filtersId:filterId,valueType:type}).done(function(data){_this2.registerStep3(data);});});},/**
		 * Register third step elements
		 */registerStep3:function registerStep3(stepContainer){var _this3=this;this.step3.append(stepContainer),this.stepNumber.val(3),App.Fields.Picklist.showSelect2ElementView(this.step3.find('select')),this.footer.hide(),this.step3.find('.groupField').on('change',function(e){_this3.step4.empty();var groupField=$(e.currentTarget);groupField.val()&&(_this3.footer.show(),AppConnector.request({module:_this3.sourceModuleName,view:_this3.widgetName,step:'step4',selectedModule:_this3.moduleName,filtersId:_this3.step2.find('.filtersId').val(),groupField:groupField.val(),chartType:_this3.chartTypeValue}).done(function(data){_this3.registerStep4(data);}));});},/**
		 * Register fourth step elements
		 */registerStep4:function registerStep4(stepContainer){var _this4=this;this.step4.append(stepContainer),this.stepNumber.val(4),App.Fields.Picklist.showSelect2ElementView(this.step4.find('select')),this.step4.find('[name="dividingField"]').on('change',function(e){var type=e.currentTarget.selectedOptions[0].dataset.fieldType,selector=_this4.step4.find('.js-sector-container');'datetime'===type||'date'===type?(selector.removeClass('d-none'),selector.find('select').attr('disabled',!1),App.Fields.Picklist.showSelect2ElementView(selector.find('select'))):(selector.addClass('d-none'),selector.find('select').attr('disabled',!0));}),app.registerModalEvents(this.container);},/**
		 * Register submit
		 */registerSubmit:function registerSubmit(){var _this5=this,form=this.form;form.validationEngine(app.validationEngineOptions),form.on('submit',function(e){if(e.preventDefault(),0===form.data('jqv').InvalidFields.length){var progressIndicatorElement=$.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params=_this5.getParams();AppConnector.request(params).done(function(data){data.success&&(app.hideModalWindow(),progressIndicatorElement.progressIndicator({mode:'hide'}),_this5.postSave(data));}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'});});}else app.formAlignmentAfterValidation(form);});},/**
		 *
		 * @param {object} response
		 */postSave:function postSave(response){var result=response.result;if(Vtiger_Helper_Js.showMessage({type:'success',text:result.text}),this.isDashboard()){var linkElement=this.source.clone();linkElement.data('name',this.widgetName),linkElement.data('id',result.wid),new Vtiger_DashBoard_Js().addWidget(linkElement,'index.php?module=Home&view=ShowWidget&name=ChartFilter&linkid='+this.source.data('linkid')+'&widgetid='+result.wid+'&active=0');}else window.location.reload();},/**
		 * Gets params for save
		 * @returns {object}
		 */getParams:function getParams(){var data={},paramsForm=this.form.serializeFormData();this.form.find('.saveParam').each(function(_,element){'undefined'!=typeof paramsForm[element.name]&&(data[element.name]=paramsForm[element.name]);});var filtersId=this.step2.find('.filtersId').val();Array.isArray(filtersId)&&(filtersId=filtersId.join(','));var formData={data:JSON.stringify(data),blockid:this.source.data('block-id'),linkid:this.source.data('linkid'),name:this.widgetName,title:paramsForm.widgetTitle,filterid:filtersId,isdefault:0,height:4,width:4,owners_all:['mine','all','users','groups'],default_owner:'mine',dashboardId:this.getCurrentDashboard()};return {form:formData,module:this.sourceModuleName,sourceModule:this.sourceModuleName||app.getModuleName(),action:'Widget',mode:'add',addToUser:this.isDashboard(),linkid:this.source.data('linkid'),name:this.widgetName}},/**
		 * Gets dashboard ID
		 * @returns {int}
		 */getCurrentDashboard:function getCurrentDashboard(){return $('.selectDashboard li a.active').closest('li').data('id')||1},/**
		 * Check if the widget is added on the dashboard
		 * @returns {boolean}
		 */isDashboard:function isDashboard(){return 0<$('.dashboardViewContainer').length&&'undefined'!=typeof Vtiger_DashBoard_Js},/**
		 * Register modal events
		 * @param {jQuery} modalContainer
		 */registerEvents:function registerEvents(modalContainer){this.container=$(modalContainer);var id=this.container.closest('.js-modal-container').attr('id');this.source=$('[data-modalid="'+id+'"]'),this.sourceModuleName=this.source.data('module'),this.registerContainers(),this.registerStep1(),this.registerSubmit();}});
//# sourceMappingURL=ChartFilter.min.js.map
