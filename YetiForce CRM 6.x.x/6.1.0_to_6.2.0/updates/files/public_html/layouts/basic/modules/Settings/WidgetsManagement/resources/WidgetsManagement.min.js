'use strict';

jQuery.Class('Settings_WidgetsManagement_Js',{},{widgetWithFilterUsers:[],setWidgetWithFilterUsers:function setWidgetWithFilterUsers(){var thisInstance=this,element=jQuery('[name="filter_users"]').val();thisInstance.widgetWithFilterUsers=element?JSON.parse(element):[];},widgetWithFilterDate:[],widgetWithRecordLimit:[],setWidgetData:function setWidgetData(){var thisInstance=this,element=$('[name="filter_date"]').val();thisInstance.widgetWithFilterDate=element?JSON.parse(element):[];var recordLimit=$('[name="record_limit"]').val();thisInstance.widgetWithRecordLimit=recordLimit?JSON.parse(recordLimit):[];},setWidgetWithFilterTitle:function setWidgetWithFilterTitle(){var thisInstance=this,element=$('[name="filter_title"]').val();thisInstance.widgetWithFilterTitle=element?JSON.parse(element):[];},restrictFilter:[],setRestrictFilter:function setRestrictFilter(){var thisInstance=this,element=jQuery('[name="filter_restrict"]').val();thisInstance.restrictFilter=element?JSON.parse(element):[];},/**
		 * Function to create the array of block roles list
		 */getAuthorization:function getAuthorization(){var authorization=[],container=jQuery('#moduleBlocks');return container.find('.editFieldsTable').each(function(){authorization.push(jQuery(this).data('code').toString());}),authorization},getAllFieldsInBlock:function getAllFieldsInBlock(continer){var fields=[];return continer.find('.blockFieldsList .editFieldsWidget').each(function(){fields.push(jQuery(this).data('linkid').toString());}),fields},multipleWidgets:function multipleWidgets(){return ['Multifilter','Upcoming events']},getCurrentDashboardId:function getCurrentDashboardId(){return $('.selectDashboard li a.active').parent().data('id')},registerAddedDashboard:function registerAddedDashboard(){var thisInstance=this;$('.addDashboard').on('click',function(){app.showModalWindow({url:'index.php?parent=Settings&module='+app.getModuleName()+'&view=DashboardType',sendByAjaxCb:function sendByAjaxCb(){var contentsDiv=$('.contentsDiv');thisInstance.getModuleLayoutEditor('Home').done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});}});});},registerSelectDashboard:function registerSelectDashboard(){var thisInstance=this;$('.selectDashboard li').on('click',function(e){var contentsDiv=$('.contentsDiv');thisInstance.getModuleLayoutEditor($('#selectedModuleName').val(),$(e.currentTarget).data('id')).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});},registerDashboardAction:function registerDashboardAction(){var thisInstance=this;$('.editDashboard').on('click',function(e){var currentTarget=$(e.currentTarget);e.stopPropagation(),app.showModalWindow({url:'index.php?parent=Settings&module='+app.getModuleName()+'&view=DashboardType&dashboardId='+currentTarget.closest('li').data('id'),sendByAjaxCb:function sendByAjaxCb(){var contentsDiv=$('.contentsDiv');thisInstance.getModuleLayoutEditor('Home',currentTarget.closest('li').data('id')).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});}});}),$('.deleteDashboard').on('click',function(e){var currentTarget=$(e.currentTarget);e.stopPropagation(),AppConnector.request({parent:'Settings',module:app.getModuleName(),action:'Dashboard',mode:'delete',dashboardId:currentTarget.closest('li').data('id')}).done(function(){var contentsDiv=$('.contentsDiv');thisInstance.getModuleLayoutEditor('Home',1).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});});},/**
		 * Function to register click event for add custom block button
		 */registerAddBlockDashBoard:function registerAddBlockDashBoard(){var thisInstance=this,contents=jQuery('#layoutDashBoards');contents.find('.addBlockDashBoard').on('click',function(){var addBlockContainer=contents.find('.addBlockDashBoardModal').clone(!0,!0),inUseAuthorization=thisInstance.getAuthorization();addBlockContainer.find('select.authorized option').each(function(){-1!=jQuery.inArray(jQuery(this).val(),inUseAuthorization)&&jQuery(this).remove();});var callBackFunction=function(data){App.Fields.Picklist.changeSelectElementView(data.find('select'));var form=data.find('.addBlockDashBoardForm'),block=form.find('[name="authorized"]');form.validationEngine(app.validationEngineOptions),form.on('submit',function(e){if(form.validationEngine('validate')){var paramsForm=form.serializeFormData();paramsForm.action='addBlock';var paramsBlock={authorized:block.val(),label:block.find(':selected').text()};thisInstance.save(paramsForm,'save').done(function(data){var params={},response=data.result;response.success?(paramsBlock.id=response.id,thisInstance.displayNewCustomBlock(paramsBlock),app.hideModalWindow(),params.text=app.vtranslate('JS_BLOCK_ADDED')):(params.text=response.message,params.type='error'),Settings_Vtiger_Index_Js.showMessage(params),window.location.reload();});}e.preventDefault();});};app.showModalWindow(addBlockContainer,function(data){'function'==typeof callBackFunction&&callBackFunction(data);},{width:'1000px'});});},save:function save(form,mode){var aDeferred=jQuery.Deferred(),progressIndicatorElement=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};return 'string'==typeof form.owners_all&&(form.owners_all=[form.owners_all]),params.form=form,params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.sourceModule=jQuery('#selectedModuleName').val(),params.action='SaveAjax',params.mode=mode,AppConnector.request(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(error){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.reject(error);}),aDeferred.promise()},displayNewCustomBlock:function displayNewCustomBlock(result){var contents=jQuery('#layoutDashBoards'),newBlockCloneCopy=contents.find('.newCustomBlockCopy').clone(!0,!0);newBlockCloneCopy.data('block-id',result.id).find('.blockLabel span').append(jQuery('<strong>'+result.label+'</strong>')),newBlockCloneCopy.find('.addCustomField').removeClass('d-none').show(),newBlockCloneCopy.find('.specialWidget').data('block-id',result.id),contents.find('#moduleBlocks').append(newBlockCloneCopy.removeClass('newCustomBlockCopy d-none').addClass('editFieldsTable block_'+result.id).data('code',result.authorized));},/*
		 * Function to add clickoutside event on the element - By using outside events plugin
		 * @params element---On which element you want to apply the click outside event
		 * @params callbackFunction---This function will contain the actions triggered after clickoutside event
		 */addClickOutSideEvent:function addClickOutSideEvent(element,callbackFunction){element.one('clickoutside',callbackFunction);},registerAddCustomFieldEvent:function registerAddCustomFieldEvent(){var thisInstance=this,contents=$('#layoutDashBoards');contents.find('.addCustomField').on('click',function(e){var continer=$(e.currentTarget).closest('.editFieldsTable'),blockId=continer.data('block-id'),addFieldContainer=contents.find('.createFieldModal').clone(!0,!0),allFieldsInBlock=thisInstance.getAllFieldsInBlock(continer),selectWidgets=addFieldContainer.find('select.widgets');selectWidgets.find('option').each(function(){-1!=$.inArray($(this).val(),allFieldsInBlock)&&-1==$.inArray($(this).data('name'),thisInstance.multipleWidgets())&&$(this).remove();});var name=selectWidgets.find(':first-child').data('name');if(-1!=$.inArray(name,thisInstance.widgetWithFilterUsers)){addFieldContainer.find('.widgetFilter').removeClass('d-none').find('select').removeAttr('disabled').show();var restrictFilter=thisInstance.restrictFilter[name];if(restrictFilter)for(var i in restrictFilter)addFieldContainer.find('.widgetFilter select option[value="'+restrictFilter[i]+'"]').remove();var filterItem=JSON.parse($('[name="filter_users_item"]').val());filterItem=filterItem[name]||filterItem['default'],addFieldContainer.find('.widgetFilter select option').each(function(){var element=$(this);-1==$.inArray(element.val(),filterItem)&&element.remove();});}-1!=$.inArray(name,thisInstance.widgetWithFilterDate)&&addFieldContainer.find('.widgetFilterDate').removeClass('d-none').find('select').removeAttr('disabled').show(),-1!=$.inArray(name,thisInstance.widgetWithFilterTitle)&&addFieldContainer.find('.widgetFilterTitle').removeClass('d-none').removeAttr('disabled').show();var callBackFunction=function(data){App.Fields.Picklist.showSelect2ElementView(data.find('select')),data.find('select.widgets').on('change',function(){data.find('.widgetFilter').remove(),data.find('.widgetFilterDate').remove(),data.find('[data-widgets]').remove(),data.find('.widgetLimit').remove(),data.find('.widgetFilterTitle').remove();var elementsToFilterTitle=contents.find('.createFieldModal .widgetFilterTitle').clone(!0,!0),elementsToFilter=contents.find('.createFieldModal .widgetFilter').clone(!0,!0),elementsToFilterDate=contents.find('.createFieldModal .widgetFilterDate').clone(!0,!0),elementsToDataWidgets=contents.find('.createFieldModal [data-widgets]').clone(!0,!0),elementsToLimit=contents.find('.createFieldModal .widgetLimit').clone(!0,!0);data.find('.modal-body').append(elementsToFilterTitle),data.find('.modal-body').append(elementsToFilter),data.find('.modal-body').append(elementsToDataWidgets),data.find('.modal-body').append(elementsToLimit),app.showPopoverElementView();var name=$(this).find(':selected').data('name');if(-1!=$.inArray(name,thisInstance.widgetWithFilterUsers)){elementsToFilter.removeClass('d-none').find('select').prop('disabled',!1);var _restrictFilter=thisInstance.restrictFilter[name];if(_restrictFilter)for(var i in _restrictFilter)addFieldContainer.find('.widgetFilter select option[value="'+_restrictFilter[i]+'"]').remove();var _filterItem=JSON.parse($('[name="filter_users_item"]').val());_filterItem=_filterItem[name]||_filterItem['default'],addFieldContainer.find('.widgetFilter select option').each(function(){var element=$(this);-1==$.inArray(element.val(),_filterItem)&&element.remove();}),App.Fields.Picklist.showSelect2ElementView(elementsToFilter.find('select'));}else elementsToFilter.addClass('d-none').find('select').prop('disabled',!0);data.find('[data-widgets]').each(function(){var element=$(this),widgets=element.data('widgets');if(name===widgets||-1!=$.inArray(name,widgets)){element.removeClass('d-none');var select=element.find('select');select.length&&(select.prop('disabled',!1),App.Fields.Picklist.showSelect2ElementView(select));}else element.addClass('d-none').find('select').prop('disabled',!0);}),-1==$.inArray(name,thisInstance.widgetWithFilterDate)?elementsToFilterDate.addClass('d-none').find('select').prop('disabled',!0):(elementsToFilterDate.removeClass('d-none').find('select').prop('disabled',!1),App.Fields.Picklist.showSelect2ElementView(elementsToFilterDate.find('select'))),-1==$.inArray(name,thisInstance.widgetWithRecordLimit)?data.find('.widgetLimit').addClass('d-none'):data.find('.widgetLimit').removeClass('d-none'),-1==$.inArray(name,thisInstance.widgetWithFilterTitle)?elementsToFilterTitle.addClass('d-none').find('input').prop('disabled',!0):elementsToFilterTitle.removeClass('d-none').find('input').prop('disabled',!1);});var form=data.find('.createCustomFieldForm');form.attr('id','createFieldForm');var widgets=form.find('[name="widgets"]');form.validationEngine($.extend(!0,{onValidationComplete:function onValidationComplete(form,valid){if(valid)if(widgets.val()){var saveButton=form.find(':submit'),field=form.find('[name="widgets"]');saveButton.attr('disabled','disabled');var paramsForm=form.serializeFormData();if(paramsForm.action='addWidget',paramsForm.blockid=blockId,paramsForm.linkid=field.val(),paramsForm.label=field.find(':selected').text(),paramsForm.name=field.find(':selected').data('name'),paramsForm.height=form.find('[name="height"]').val(),paramsForm.width=form.find('[name="width"]').val(),form.find('[name="showFullName"]').prop('checked')&&(paramsForm.showFullName=1),form.find('[name="isdefault"]').prop('checked')&&(paramsForm.isdefault=1),form.find('[name="cache"]').prop('checked')&&(paramsForm.cache=1),paramsForm.default_owner&&'undefined'==typeof paramsForm.owners_all)return form.find('select[name="owners_all"]').prev('div').validationEngine('showPrompt',app.vtranslate('JS_FIELD_EMPTY'),'error','bottomLeft',!0),saveButton.removeAttr('disabled'),e.preventDefault(),!1;thisInstance.save(paramsForm,'save').done(function(data){var result=data.result,params={};if(data.success)app.hideModalWindow(),paramsForm.id=result.id,paramsForm.status=result.status,params.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.showCustomField(paramsForm);else {var errorField,message=data.error.message;errorField=513==data.error.code?form.find('[name="fieldLabel"]'):form.find('[name="fieldName"]'),errorField.validationEngine('showPrompt',message,'error','topLeft',!0),saveButton.removeAttr('disabled');}});}else return widgets.prev('div').validationEngine('showPrompt',app.vtranslate('JS_FIELD_EMPTY'),'error','topLeft',!0),void e.preventDefault();//To prevent form submit
return !1}},app.validationEngineOptions));};app.showModalWindow(addFieldContainer,function(data){'function'==typeof callBackFunction&&callBackFunction(data);},{width:'1000px'});});},/**
		 * Function to add new custom field ui to the list
		 */showCustomField:function showCustomField(result){var thisInstance=this,contents=jQuery('#layoutDashBoards'),relatedBlock=contents.find('.block_'+result.blockid),fieldCopy=contents.find('.newCustomFieldCopy').clone(!0,!0),fieldContainer=fieldCopy.find('.js-custom-field');fieldContainer.addClass('opacity editFieldsWidget').attr('data-field-id',result.id).attr('data-block-id',result.blockid).attr('data-linkid',result.linkid),fieldContainer.find('.deleteCustomField, .saveFieldDetails').attr('data-field-id',result.id),result.title?fieldContainer.find('.fieldLabel').html(result.title):fieldContainer.find('.fieldLabel').html(result.label),result.status||fieldContainer.find('input[name="limit"]').closest('div.limit').remove(),'undefined'!=typeof result.default_owner&&fieldContainer.find('.widgetFilterAll').removeClass('d-none').show();var block=relatedBlock.find('.blockFieldsList'),sortable1=block.find('ul[name=sortable1]'),length1=sortable1.children().length,sortable2=block.find('ul[name=sortable2]'),length2=sortable2.children().length;// Deciding where to add the new field
length1>length2?sortable2.append(fieldCopy.removeClass('d-none newCustomFieldCopy')):sortable1.append(fieldCopy.removeClass('d-none newCustomFieldCopy'));var form=fieldCopy.find('form.fieldDetailsForm');thisInstance.setFieldDetails(result,form);},/**
		 * Function to set the field info for edit field actions
		 */setFieldDetails:function setFieldDetails(result,form){if(form.find('.modal-header').html($('<h5 class="modal-title">'+result.label+'</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>')),result.showFullName&&form.find('[name="showFullName"]').filter(':checkbox').attr('checked',!0),result.isdefault&&form.find('[name="isdefault"]').filter(':checkbox').attr('checked',!0),result.cache&&form.find('[name="cache"]').filter(':checkbox').attr('checked',!0),result.width&&(form.find('select[name="width"]').find('option').removeAttr('selected'),form.find('select[name="width"]').find('option[value="'+result.width+'"]').attr('selected','selected')),result.height&&(form.find('select[name="height"]').find('option').removeAttr('selected'),form.find('select[name="height"]').find('option[value="'+result.height+'"]').attr('selected','selected')),result.default_owner&&(form.find('select[name="default_owner"]').find('option').removeAttr('selected'),form.find('select[name="default_owner"]').find('option[value="'+result.default_owner+'"]').attr('selected','selected')),result.owners_all){form.find('select[name="owners_all"]').find('option').removeAttr('selected');var selectedvalue=result.owners_all;if('string'!=typeof selectedvalue)for(var encodedSelectedValue,i=0;i<selectedvalue.length;i++)encodedSelectedValue=selectedvalue[i].replace(/"/g,'\\"'),form.find('select[name="owners_all"]').find('option[value="'+encodedSelectedValue+'"]').attr('selected','selected');else form.find('select[name="owners_all"]').find('option[value="'+selectedvalue+'"]').attr('selected','selected');}},registerEditFieldDetailsClick:function registerEditFieldDetailsClick(){var contents=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,thisInstance=this;contents||(contents=jQuery('#layoutDashBoards')),contents.find('.editFieldDetails').on('click',function(e){var currentTarget=$(e.currentTarget),fieldRow=currentTarget.closest('div.editFieldsWidget');fieldRow.removeClass('opacity');var basicDropDown=fieldRow.find('.basicFieldOperations'),dropDownContainer=currentTarget.closest('.btn-group');dropDownContainer.find('.dropdown-menu').remove();var dropDown=basicDropDown.clone().removeClass('basicFieldOperations d-none').addClass('dropdown-menu p-0');dropDownContainer.append(dropDown);var dropDownMenu=dropDownContainer.find('.dropdown-menu');dropDownContainer.dropdown('dispose').dropdown('toggle'),dropDownMenu.find('form').validationEngine($.extend(!0,{binded:!1,onValidationComplete:function onValidationComplete(form,valid){if(valid){if(void 0===form)return !0;var paramsForm=form.serializeFormData();form.find('[name="showFullName"]').prop('checked')&&(paramsForm.showFullName=1),form.find('[name="isdefault"]').prop('checked')&&(paramsForm.isdefault=1),form.find('[name="cache"]').prop('checked')&&(paramsForm.cache=1);var id=form.find('.saveFieldDetails').data('field-id');if(paramsForm.action='saveDetails',paramsForm.id=id,'undefined'==typeof paramsForm.customMultiFilter||$.isArray(paramsForm.customMultiFilter)||(paramsForm.customMultiFilter=[paramsForm.customMultiFilter]),paramsForm.default_owner&&'undefined'==typeof paramsForm.owners_all){var params={};return params.type='error',params.text=app.vtranslate('JS_FILTERS_AVAILABLE')+': '+app.vtranslate('JS_FIELD_EMPTY'),Settings_Vtiger_Index_Js.showMessage(params),e.preventDefault(),!1}thisInstance.save(paramsForm,'save'),thisInstance.registerSaveFieldDetailsEvent(form);}return !1}},app.getvalidationEngineOptions(!0)));var selectElements=basicDropDown.find('select[name="owners_all"]');0<selectElements.length&&!selectElements.hasClass('select2-hidden-accessible')&&App.Fields.Picklist.showSelect2ElementView(dropDownMenu.find('select[name="owners_all"]')),selectElements=basicDropDown.find('select[name="default_date"]'),0<selectElements.length&&App.Fields.Picklist.showSelect2ElementView(dropDownMenu.find('select[name="default_date"]')),selectElements=basicDropDown.find('select[name="customMultiFilter"]'),0<selectElements.length&&App.Fields.Picklist.showSelect2ElementView(dropDownMenu.find('select[name="customMultiFilter"]')),selectElements=basicDropDown.find('select[name="defaultFilter"]'),0<selectElements.length&&App.Fields.Picklist.showSelect2ElementView(dropDownMenu.find('select[name="defaultFilter"]')),thisInstance.avoidDropDownClick(dropDownContainer),dropDownMenu.on('change',':checkbox',function(e){var currentTarget=jQuery(e.currentTarget);if('readonly'===currentTarget.attr('readonly')){var status=jQuery(e.currentTarget).is(':checked');status?$(e.currentTarget).removeAttr('checked'):$(e.currentTarget).attr('checked','checked'),e.preventDefault();}});var callbackFunction=function(){fieldRow.addClass('opacity'),dropDown.remove();};thisInstance.addClickOutSideEvent(dropDown,callbackFunction),$('.cancel,.close').on('click',callbackFunction);});},/**
		 * Function to register the click event for save button after edit field details
		 */registerSaveFieldDetailsEvent:function registerSaveFieldDetailsEvent(form){var submitButtton=form.find('.saveFieldDetails'),fieldRow=submitButtton.closest('.editFieldsWidget'),dropDownMenu=form.closest('.dropdown-menu');//close the drop down
//adding class opacity to fieldRow - to give opacity to the actions of the fields
submitButtton.closest('.btn-group').removeClass('open'),fieldRow.addClass('opacity'),form.find('select').each(function(){var encodedSelectedValue,selectedValue=$(this).val();if($(this).find('option').removeAttr('selected'),'undefined'==typeof $(this).attr('multiple'))encodedSelectedValue=selectedValue.replace(/"/g,'\\"'),$(this).find('[value="'+encodedSelectedValue+'"]').attr('selected','selected');else for(var i=0;i<selectedValue.length;i++)encodedSelectedValue=selectedValue[i].replace(/"/g,'\\"'),$(this).find('[value="'+encodedSelectedValue+'"]').attr('selected','selected');}),form.closest('.editFieldsWidget').find('.basicFieldOperations').html(form),dropDownMenu.remove();},/**
		 * Function to register click event for drop-downs in fields list
		 */avoidDropDownClick:function avoidDropDownClick(dropDownContainer){dropDownContainer.find('.dropdown-menu').on('click',function(e){e.stopPropagation();});},registerSpecialWidget:function registerSpecialWidget(){var thisInstance=this,container=jQuery('#layoutDashBoards');container.find('.addNotebook').on('click',function(){thisInstance.addNoteBookWidget(this,jQuery(this).data('url'));}),container.find('.addMiniList').on('click',function(){thisInstance.addMiniListWidget(this,jQuery(this).data('url'));}),container.find('.addRss').on('click',function(e){thisInstance.addRssWidget($(e.currentTarget),jQuery(this).data('url'));});},addRssWidget:function addRssWidget(element){var thisInstance=this,objectToShowModal={url:'index.php?module='+app.getModuleName()+'&parent='+app.getParentModuleName()+'&view=AddRss',cb:function cb(container){container.find('.removeChannel').on('click',function(e){var currentTarget=$(e.currentTarget),row=currentTarget.closest('.form-group');row.remove();}),container.find('.addChannel').on('click',function(){var newRow=container.find('.newChannel').clone(),formContainer=container.find('.formContainer');formContainer.append(newRow),newRow.removeClass('d-none'),newRow.removeClass('newChannel'),newRow.find('input').removeAttr('disabled'),newRow.find('.removeChannel').on('click',function(e){var currentTarget=$(e.currentTarget),row=currentTarget.closest('.form-group');row.remove();});}),container.find('[name="blockid"]').val(element.data('blockId')),container.find('[name="linkid"]').val(element.data('linkid'));var form=container.find('form'),submit=form.find('[type="submit"]');submit.on('click',function(e){var channels=[];if(form.validationEngine('validate')){form.find('.channelRss:not(:disabled)').each(function(){channels.push(jQuery(this).val());});var paramsForm=form.serializeFormData();paramsForm.data=JSON.stringify({channels:channels}),thisInstance.save(paramsForm,'save').done(function(data){paramsForm.label=paramsForm.title,thisInstance.saveAfterInfo(data,paramsForm);});}e.preventDefault();});}};app.showModalWindow(objectToShowModal);},saveAfterInfo:function saveAfterInfo(data,paramsForm){var thisInstance=this,result=data.result,params={};data.success&&(app.hideModalWindow(),paramsForm.id=result.id,paramsForm.status=result.status,params.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.showCustomField(paramsForm));},addNoteBookWidget:function addNoteBookWidget(element){var thisInstance=this;element=jQuery(element),app.showModalWindow(null,'index.php?module=Home&view=AddNotePad',function(wizardContainer){var form=jQuery('form',wizardContainer);form.validationEngine($.extend(!0,{onValidationComplete:function onValidationComplete(form,valid){if(valid){jQuery('[name=\'saveButton\']',wizardContainer).attr('disabled','disabled');var notePadName=form.find('[name="notePadName"]').val(),notePadContent=form.find('[name="notePadContent"]').val(),linkId=element.data('linkid'),blockId=element.data('block-id'),noteBookParams={module:jQuery('#selectedModuleName').val(),action:'NoteBook',mode:'noteBookCreate',notePadName:notePadName,notePadContent:notePadContent,blockid:blockId,linkId:linkId,isdefault:0,width:4,height:3};AppConnector.request(noteBookParams).done(function(data){if(data.result.success){var widgetId=data.result.widgetId;app.hideModalWindow(),noteBookParams.id=widgetId,noteBookParams.label=notePadName,Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate('JS_WIDGET_ADDED')}),thisInstance.showCustomField(noteBookParams);}});}return !1}},app.validationEngineOptions));});},addMiniListWidget:function addMiniListWidget(element){// 1. Show popup window for selection (module, filter, fields)
// 2. Compute the dynamic mini-list widget url
// 3. Add widget with URL to the page.
var thisInstance=this;element=$(element),app.showModalWindow(null,'index.php?module=Home&view=MiniListWizard&step=step1',function(wizardContainer){var form=$('form',wizardContainer),moduleNameSelectDOM=$('select[name="module"]',wizardContainer),filteridSelectDOM=$('select[name="filterid"]',wizardContainer),fieldHrefDOM=$('select[name="field_href"]',wizardContainer),fieldsSelectDOM=$('select[name="fields"]',wizardContainer),filterFieldsSelectDOM=$('select[name="filter_fields"]',wizardContainer),moduleNameSelect2=App.Fields.Picklist.showSelect2ElementView(moduleNameSelectDOM,{placeholder:app.vtranslate('JS_SELECT_MODULE')}),filteridSelect2=App.Fields.Picklist.showSelect2ElementView(filteridSelectDOM,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION')}),fieldHrefSelect2=App.Fields.Picklist.showSelect2ElementView(fieldHrefDOM,{allowClear:!0}),fieldsSelect2=App.Fields.Picklist.showSelect2ElementView(fieldsSelectDOM,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION'),closeOnSelect:!0,maximumSelectionLength:6}),filterFieldsSelect2=App.Fields.Picklist.showSelect2ElementView(filterFieldsSelectDOM,{placeholder:app.vtranslate('JS_PLEASE_SELECT_ATLEAST_ONE_OPTION')}),footer=$('.modal-footer',wizardContainer);filteridSelectDOM.closest('tr').hide(),fieldHrefDOM.closest('tr').hide(),fieldsSelectDOM.closest('tr').hide(),filterFieldsSelectDOM.closest('tr').hide(),footer.hide(),moduleNameSelect2.on('change',function(){moduleNameSelect2.val()&&AppConnector.request({module:'Home',view:'MiniListWizard',step:'step2',selectedModule:moduleNameSelect2.val()}).done(function(res){filteridSelectDOM.empty().html(res).trigger('change'),filteridSelect2.closest('tr').show(),fieldsSelectDOM.closest('tr').hide(),filterFieldsSelectDOM.closest('tr').hide();});}),filteridSelect2.on('change',function(){filteridSelect2.val()&&(footer.hide(),fieldsSelectDOM.closest('tr').hide(),filterFieldsSelectDOM.closest('tr').hide(),AppConnector.request({module:'Home',view:'MiniListWizard',step:'step3',selectedModule:moduleNameSelect2.val(),filterid:filteridSelect2.val()}).done(function(res){res=$(res),fieldsSelectDOM.empty().html(res.find('select[name="fields"]').html()).trigger('change'),filterFieldsSelectDOM.empty().html(res.find('select[name="filter_fields"]').html()).trigger('change'),fieldsSelect2.closest('tr').show(),fieldHrefSelect2.closest('tr').show(),filterFieldsSelect2.closest('tr').show(),fieldsSelect2.data('select2').$selection.find('.select2-search__field').parent().css('width','100%'),filterFieldsSelect2.data('select2').$selection.find('.select2-search__field').parent().css('width','100%');}));}),fieldsSelect2.on('change',function(){fieldHrefDOM.find('option:not([value=""]').remove(),$(this).find('option:checked').each(function(index,element){var option=$(element),newOption=new Option(option.text(),option.val(),!0,!0);fieldHrefSelect2.append(newOption);}),fieldHrefSelect2.val('').trigger('change'),fieldsSelect2.val()?footer.show():footer.hide();}),form.on('submit',function(e){e.preventDefault();var selectedFields=[];fieldsSelect2.select2('data').map(function(obj){selectedFields.push(obj.id);});var data={module:moduleNameSelect2.val(),fields:selectedFields,filterFields:filterFieldsSelect2.val(),fieldHref:fieldHrefSelect2.val()},paramsForm={data:JSON.stringify(data),action:'addWidget',blockid:element.data('block-id'),title:form.find('[name="widgetTitle"]').val(),linkid:element.data('linkid'),label:moduleNameSelect2.find(':selected').text()+' - '+filteridSelect2.find(':selected').text(),name:'Mini List',filterid:filteridSelect2.val(),isdefault:0,cache:0,height:4,width:4,owners_all:['mine','all','users','groups'],default_owner:'mine'};thisInstance.save(paramsForm,'save').done(function(data){var result=data.result,params={};if(data.success)app.hideModalWindow(),paramsForm.id=result.id,paramsForm.status=result.status,params.text=app.vtranslate('JS_WIDGET_ADDED'),Settings_Vtiger_Index_Js.showMessage(params),thisInstance.showCustomField(paramsForm);else {var errorField,message=data.error.message;errorField=513===data.error.code?form.find('[name="fieldLabel"]'):form.find('[name="fieldName"]'),errorField.validationEngine('showPrompt',message,'error','topLeft',!0);}});});});},/**
		 * Function to register the click event for delete custom field
		 */registerDeleteCustomFieldEvent:function registerDeleteCustomFieldEvent(contents){var thisInstance=this;'undefined'==typeof contents&&(contents=jQuery('#layoutDashBoards')),contents.find('a.deleteCustomField').on('click',function(e){var currentTarget=jQuery(e.currentTarget),fieldId=currentTarget.data('field-id'),paramsForm={};paramsForm.action='removeWidget',paramsForm.id=fieldId;var message=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(){thisInstance.save(paramsForm,'delete').done(function(){var field=currentTarget.closest('div.editFieldsWidget'),blockId=field.data('block-id');field.parent().fadeOut('slow').remove();var block=jQuery('#block_'+blockId);thisInstance.reArrangeBlockFields(block);var params={};params.text=app.vtranslate('JS_CUSTOM_FIELD_DELETED'),Settings_Vtiger_Index_Js.showMessage(params);});});});},/**
		 * Function that rearranges fields in the block when the fields are moved
		 * @param <jQuery object> block
		 */reArrangeBlockFields:function reArrangeBlockFields(block){// 1.get the containers, 2.compare the length, 3.if uneven then move the last element
var leftSideContainer=block.find('ul[name=sortable1]'),rightSideContainer=block.find('ul[name=sortable2]');if(leftSideContainer.children().length<rightSideContainer.children().length){var lastElementInRightContainer=rightSideContainer.children(':last');leftSideContainer.append(lastElementInRightContainer);}else if(leftSideContainer.children().length>rightSideContainer.children().length+1){//greater than 1
var lastElementInLeftContainer=leftSideContainer.children(':last');rightSideContainer.append(lastElementInLeftContainer);}},/**
		 * Function to register the click event for delete custom block
		 */registerDeleteCustomBlockEvent:function registerDeleteCustomBlockEvent(){var thisInstance=this,contents=jQuery('#layoutDashBoards');contents.on('click','.js-delete-custom-block-btn',function(e){var currentTarget=jQuery(e.currentTarget),table=currentTarget.closest('div.editFieldsTable'),blockId=table.data('block-id'),paramsFrom={};paramsFrom.blockid=blockId,paramsFrom.action='removeBlock';var message=app.vtranslate('JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE');Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(){thisInstance.save(paramsFrom,'delete').done(function(){thisInstance.removeDeletedBlock(blockId,'delete');var params={};params.text=app.vtranslate('JS_CUSTOM_BLOCK_DELETED'),Settings_Vtiger_Index_Js.showMessage(params);});});});},/**
		 * Function to remove the deleted custom block from the ui
		 */removeDeletedBlock:function removeDeletedBlock(blockId){var contents=jQuery('#layoutDashBoards'),deletedTable=contents.find('.block_'+blockId);deletedTable.fadeOut('slow').remove();},/**
		 * Function to register the change event for layout editor modules list
		 */registerModulesChangeEvent:function registerModulesChangeEvent(){var thisInstance=this,container=$('#widgetsManagementEditorContainer'),contentsDiv=container.closest('.contentsDiv');App.Fields.Picklist.changeSelectElementView(container.find('[name="widgetsManagementEditorModules"]')),container.on('change','[name="widgetsManagementEditorModules"]',function(e){thisInstance.getModuleLayoutEditor($(e.currentTarget).val(),thisInstance.getCurrentDashboardId()).done(function(data){thisInstance.updateContentsDiv(contentsDiv,data);});});},/**
		 * Update contents div and register events.
		 * @param {jQuery} contentsDiv
		 * @param {HTMLElement} data
		 */updateContentsDiv:function updateContentsDiv(contentsDiv,data){contentsDiv.html(data),App.Fields.Picklist.showSelect2ElementView(contentsDiv.find('.select2')),this.registerEvents();},/**
		 * Function to get the respective module layout editor through pjax
		 */getModuleLayoutEditor:function getModuleLayoutEditor(selectedModule,selectedDashboard){var aDeferred=jQuery.Deferred(),progressIndicatorElement=jQuery.progressIndicator({position:'html',blockInfo:{enabled:!0}}),params={};return params.module=app.getModuleName(),params.parent=app.getParentModuleName(),params.view='Configuration',params.sourceModule=selectedModule,params.dashboardId=selectedDashboard,AppConnector.requestPjax(params).done(function(data){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.resolve(data);}).fail(function(){progressIndicatorElement.progressIndicator({mode:'hide'}),aDeferred.reject();}),aDeferred.promise()},/**
		 * register events for layout editor
		 */registerEvents:function registerEvents(){var thisInstance=this;thisInstance.registerAddBlockDashBoard(),thisInstance.registerAddCustomFieldEvent(),thisInstance.registerEditFieldDetailsClick(),thisInstance.registerSpecialWidget(),thisInstance.registerDeleteCustomFieldEvent(),thisInstance.registerDeleteCustomBlockEvent(),thisInstance.registerModulesChangeEvent(),thisInstance.setWidgetWithFilterUsers(),thisInstance.setRestrictFilter(),thisInstance.setWidgetData(),thisInstance.setWidgetWithFilterTitle(),thisInstance.registerAddedDashboard(),thisInstance.registerSelectDashboard(),thisInstance.registerDashboardAction();}}),jQuery(document).ready(function(){var instance=new Settings_WidgetsManagement_Js;instance.registerEvents();});
//# sourceMappingURL=WidgetsManagement.min.js.map
