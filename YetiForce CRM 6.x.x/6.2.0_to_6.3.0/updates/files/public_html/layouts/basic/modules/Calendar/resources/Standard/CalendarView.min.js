'use strict';

/*+***********************************************************************************
 * The contents of this file are subject to the vtiger CRM Public License Version 1.0
 * ("License"); You may not use this file except in compliance with the License
 * The Original Code is:  vtiger CRM Open Source
 * The Initial Developer of the Original Code is vtiger.
 * Portions created by vtiger are Copyright (C) vtiger.
 * All Rights Reserved.
 *************************************************************************************/'use strict';/**
 *  Class representing a standard calendar.
 * @extends Calendar_Js
 */function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor);}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(3>arguments.length?target:receiver):desc.value}},_get.apply(this,arguments)}function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&(object=_getPrototypeOf(object),null!==object););return object}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(self)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return !1;if(Reflect.construct.sham)return !1;if("function"==typeof Proxy)return !0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return !1}}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}window.Calendar_Calendar_Js=/*#__PURE__*/function(_Calendar_Js){function _class(){return _classCallCheck(this,_class),_super.apply(this,arguments)}_inherits(_class,_Calendar_Js);var _super=_createSuper(_class);return _createClass(_class,[{key:"setCalendarModuleOptions",value:function setCalendarModuleOptions(){var self=this;return {select:function select(start,end){self.selectDays(start,end),self.getCalendarView().fullCalendar("unselect");},eventClick:function eventClick(calEvent,jsEvent){jsEvent.preventDefault();var link=new URL($(this)[0].href);if(self.createView){var progressInstance=jQuery.progressIndicator({blockInfo:{enabled:!0}}),callbackFunction=function(){progressInstance.progressIndicator({mode:"hide"});};app.showModalWindow({url:"index.php?module=".concat(this.module,"&view=ActivityStateModal&record=").concat(link.searchParams.get("record")),cb:callbackFunction});}else window.location.assign("index.php?module=".concat(this.module,"&view=Detail&record=").concat(link.searchParams.get("record")));}}}},{key:"getValuesFromSelect2",value:function getValuesFromSelect2(element,data,text){if(element.hasClass("select2-hidden-accessible"))for(var types=element.select2("data"),i=0;i<types.length;i++)text?data.push(types[i].text):data.push(types[i].id);return data}},{key:"getDefaultParams",value:function getDefaultParams(){var parentParams=_get(_getPrototypeOf(_class.prototype),"getDefaultParams",this).call(this),users=app.moduleCacheGet("calendar-groups")||[],filters=[];$(".calendarFilters .filterField").each(function(){var name,value,element=$(this);"checkbox"==element.attr("type")?(name=element.val(),value=element.prop("checked")?1:0):(name=element.attr("name"),value=element.val()),filters.push({name:name,value:value});});var params={time:app.getMainParams("showType"),filters:filters};return users.length&&(params.user=parentParams.user.concat(users),params.emptyFilters=!1),params=Object.assign(parentParams,params),params}},{key:"selectDays",value:function selectDays(startDate,endDate){var thisInstance=this,start_hour=app.getMainParams("startHour"),end_hour=app.getMainParams("endHour");!1==endDate.hasTime()&&endDate.add(-1,"days"),startDate=startDate.format(),endDate=endDate.format();var view=thisInstance.getCalendarView().fullCalendar("getView");""==start_hour&&(start_hour="00"),""==end_hour&&(end_hour="00"),this.getCalendarCreateView().done(function(data){if(!(0>=data.length)){if("agendaDay"!=view.name&&"agendaWeek"!=view.name&&(startDate=startDate+"T"+start_hour+":00",endDate=endDate+"T"+start_hour+":00",startDate==endDate)){var activityType=data.find("[name=\"activitytype\"]").val(),activityDurations=JSON.parse(data.find("[name=\"defaultOtherEventDuration\"]").val()),minutes=0;for(var i in activityDurations)if(activityDurations[i].activitytype===activityType){minutes=parseInt(activityDurations[i].duration);break}endDate=moment(endDate).add(minutes,"minutes").toISOString();}var dateFormat=data.find("[name=\"date_start\"]").data("dateFormat").toUpperCase(),timeFormat=data.find("[name=\"time_start\"]").data("format");if(24==timeFormat)var defaultTimeFormat="HH:mm";else defaultTimeFormat="hh:mm A";var startDateString=moment(startDate).format(dateFormat),startTimeString=moment(startDate).format(defaultTimeFormat),endDateString=moment(endDate).format(dateFormat),endTimeString=moment(endDate).format(defaultTimeFormat);data.find("[name=\"date_start\"]").val(startDateString),data.find("[name=\"due_date\"]").val(endDateString),data.find("[name=\"time_start\"]").val(startTimeString),data.find("[name=\"time_end\"]").val(endTimeString),App.Components.QuickCreate.showModal(data,{callbackFunction:function callbackFunction(data){thisInstance.addCalendarEvent(data.result);}});}});}},{key:"isNewEventToDisplay",value:function isNewEventToDisplay(eventObject){if(_get(_getPrototypeOf(_class.prototype),"isNewEventToDisplay",this).call(this,eventObject)){var taskstatus=$.inArray(eventObject.activitystatus.value,["PLL_POSTPONED","PLL_CANCELLED","PLL_COMPLETED"]),state=$(".fc-toolbar .js-switch--label-on").last().hasClass("active");return !(!0===state&&0<=taskstatus||!0!=state&&-1==taskstatus)}return !1}},{key:"getCalendarCreateView",value:function getCalendarCreateView(){var thisInstance=this,aDeferred=jQuery.Deferred();if(!1!==this.calendarCreateView)return aDeferred.resolve(this.calendarCreateView.clone(!0,!0)),aDeferred.promise();var progressInstance=jQuery.progressIndicator({blockInfo:{enabled:!0}});return this.loadCalendarCreateView().done(function(data){progressInstance.progressIndicator({mode:"hide"}),thisInstance.calendarCreateView=data,aDeferred.resolve(data.clone(!0,!0));}).fail(function(error){progressInstance.progressIndicator({mode:"hide"}),console.error(error);}),aDeferred.promise()}},{key:"loadCalendarCreateView",value:function loadCalendarCreateView(){var aDeferred=jQuery.Deferred(),url="index.php?module=".concat(this.module,"&view=QuickCreateAjax");return App.Components.QuickCreate.getForm(url,this.module).done(function(data){aDeferred.resolve(jQuery(data));}).fail(function(){aDeferred.reject();}),aDeferred.promise()}},{key:"switchTpl",value:function switchTpl(on,off,state){return "<div class=\"btn-group btn-group-toggle js-switch c-calendar-switch\" data-toggle=\"buttons\">\n\t\t\t\t\t<label class=\"btn btn-outline-primary c-calendar-switch__button js-switch--label-on ".concat(state?"":"active","\">\n\t\t\t\t\t\t<input type=\"radio\" name=\"options\" data-on-text=\"").concat(on,"\" autocomplete=\"off\" ").concat(state?"":"checked",">\n\t\t\t\t\t\t").concat(on,"\n\t\t\t\t\t</label>\n\t\t\t\t\t<label class=\"btn btn-outline-primary c-calendar-switch__button ").concat(state?"active":"","\">\n\t\t\t\t\t\t<input type=\"radio\" name=\"options\" data-off-text=\"").concat(off,"\" autocomplete=\"off\" ").concat(state?"checked":"",">\n\t\t\t\t\t\t").concat(off,"\n\t\t\t\t\t</label>\n\t\t\t\t</div>")}},{key:"registerSwitchEvents",value:function registerSwitchEvents(){var switchHistory,switchAllDays,_this=this,calendarview=this.getCalendarView(),switchContainer=$("<div class=\"js-calendar-switch-container\"></div>").insertAfter(calendarview.find(".fc-center"));switchHistory="current"!=app.getMainParams("showType")||"history"==app.moduleCacheGet("defaultShowType"),$(this.switchTpl(app.vtranslate("JS_TO_REALIZE"),app.vtranslate("JS_HISTORY"),switchHistory)).prependTo(switchContainer).on("change","input",function(e){var currentTarget=$(e.currentTarget);"undefined"==typeof currentTarget.data("on-text")?"undefined"!=typeof currentTarget.data("off-text")&&(app.setMainParams("showType","history"),app.moduleCacheSet("defaultShowType","history")):(app.setMainParams("showType","current"),app.moduleCacheSet("defaultShowType","current")),_this.loadCalendarData();}),switchAllDays="workDays"!==app.getMainParams("switchingDays")||"all"===app.moduleCacheGet("defaultSwitchingDays"),!1!==app.getMainParams("hiddenDays",!0)&&$(this.switchTpl(app.vtranslate("JS_WORK_DAYS"),app.vtranslate("JS_ALL"),switchAllDays)).prependTo(switchContainer).on("change","input",function(e){var currentTarget=$(e.currentTarget),hiddenDays=[];"undefined"==typeof currentTarget.data("on-text")?"undefined"!=typeof currentTarget.data("off-text")&&(app.setMainParams("switchingDays","all"),app.moduleCacheSet("defaultSwitchingDays","all")):(app.setMainParams("switchingDays","workDays"),app.moduleCacheSet("defaultSwitchingDays","workDays"),hiddenDays=app.getMainParams("hiddenDays",!0)),calendarview.fullCalendar("option","hiddenDays",hiddenDays),_this.registerSwitchEvents(),_this.loadCalendarData();});}},{key:"registerCacheSettings",value:function registerCacheSettings(){var thisInstance=this,calendar=thisInstance.getCalendarView();$(".siteBarRight .filterField").each(function(){var name=$(this).attr("id"),value=app.moduleCacheGet(name),element=$("#"+name);0<element.length&&null!=value&&"checkbox"==element.attr("type")&&element.prop("checked",value);}),calendar.find(".fc-toolbar .fc-button").on("click",function(e){var view,element=$(e.currentTarget);view=calendar.fullCalendar("getView"),element.hasClass("fc-"+view.name+"-button")?app.moduleCacheSet("defaultView",view.name):(element.hasClass("fc-prev-button")||element.hasClass("fc-next-button")||element.hasClass("fc-today-button"))&&(app.moduleCacheSet("start",view.start.format()),app.moduleCacheSet("end",view.end.format()));});var keys=app.moduleCacheKeys();if(0<keys.length){var alert=$("#moduleCacheAlert");$(".bodyContents").on("Vtiger.Widget.Load.undefined",function(){alert.removeClass("d-none");}),alert.find(".cacheClear").on("click",function(){app.moduleCacheClear(),alert.addClass("d-none"),location.reload();});}}},{key:"registerEvents",value:function registerEvents(){_get(_getPrototypeOf(_class.prototype),"registerEvents",this).call(this),this.registerCacheSettings(),this.registerSwitchEvents();}}]),_class}(Calendar_Js);
//# sourceMappingURL=CalendarView.min.js.map
