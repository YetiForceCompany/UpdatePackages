{"version":3,"file":"Connector.min.js","sources":["Connector.js"],"sourcesContent":["/*+***********************************************************************************\n * The contents of this file are subject to the vtiger CRM Public License Version 1.0\n * (\"License\"); You may not use this file except in compliance with the License\n * The Original Code is:  vtiger CRM Open Source\n * The Initial Developer of the Original Code is vtiger.\n * Portions created by vtiger are Copyright (C) vtiger.\n * All Rights Reserved.\n *************************************************************************************/\n'use strict';\n\nwindow.AppConnector = {\n  /**\n   * Sends a pjax request (push state +ajax)\n   * The function is deferred. it will be resolved on success and error on failure\n   *  Success - if request is success it will send you data that it recieved\n   *  error - it will send two parameters first gives string regarding error\n   *                   Second gives you error object if exists\n   *\n   *  @return - deferred promise\n   */\n  requestPjax: function (params) {\n    return AppConnector._request(params, true);\n  },\n\n  /**\n   *  Sends ajax request to the specified url.\n   *  The function is deferred. it will be resolved on success and error on failure\n   *  Success - if request is success it will send you data that it recieved\n   *  error - it will send two parameters first gives string regarding error\n   *                   Second gives you error object if exists\n   *\n   *  @return - deferred promise\n   */\n  request: function (params, rawData) {\n    return AppConnector._request(params, false, rawData);\n  },\n\n  _request: function (params, pjaxMode, rawData) {\n    const aDeferred = jQuery.Deferred();\n    if (typeof rawData === 'undefined') {\n      rawData = false;\n    }\n    if (typeof pjaxMode === 'undefined') {\n      pjaxMode = false;\n    }\n    if (typeof params === 'undefined') {\n      params = {};\n    }\n    let fullUrl = '',\n      index,\n      callerParams;\n    //caller has send only data\n    if (typeof params.data === 'undefined' || rawData) {\n      if (typeof params === 'string') {\n        callerParams = fullUrl = params;\n        index = callerParams.indexOf('?');\n        if (index !== -1) {\n          let subStr = callerParams.substr(0, index + 1); //need to replace only \"index.php?\" or \"?\"\n          callerParams = callerParams.replace(subStr, '');\n        }\n      } else {\n        callerParams = $.extend({}, params);\n      }\n      params = {};\n      params.data = callerParams;\n    }\n    //Make the request as post by default\n    if (typeof params.type === 'undefined' || rawData) params.type = 'POST';\n    if (typeof params.jsonp === 'undefined' || rawData) params.jsonp = false;\n\n    //By default we expect json from the server\n    if (typeof params.dataType === 'undefined' || rawData) {\n      let data = params.data;\n      //view will return html\n      params.dataType = 'json';\n      if (data.hasOwnProperty('view')) {\n        params.dataType = 'html';\n      } else if (typeof data === 'string' && data.indexOf('&view=') !== -1) {\n        params.dataType = 'html';\n      }\n      if (typeof params.url !== 'undefined' && params.url.indexOf('&view=') !== -1) {\n        params.dataType = 'html';\n      }\n    }\n    //If url contains params then seperate them and make them as data\n    if (typeof params.url !== 'undefined' && params.url.indexOf('?') !== -1) {\n      fullUrl = params.url;\n      let urlSplit = params.url.split('?'),\n        queryString = urlSplit[1];\n      params.url = urlSplit[0];\n      let queryParameters = queryString.split('&');\n      for (index = 0; index < queryParameters.length; index++) {\n        let queryParam = queryParameters[index],\n          queryParamComponents = queryParam.split('=');\n        params.data[queryParamComponents[0]] = queryParamComponents[1];\n      }\n    }\n    if (typeof params.url === 'undefined' || params.url.length <= 0) {\n      params.url = 'index.php';\n    }\n    params.success = function (data, status, jqXHR) {\n      if (data !== null && typeof data === 'object' && data.error) {\n        app.errorLog(data.error);\n        if (data.error.message) {\n          Vtiger_Helper_Js.showMessage({\n            text: data.error.message,\n            type: 'error',\n          });\n        }\n      }\n      aDeferred.resolve(data);\n    };\n    params.error = function (jqXHR, textStatus, errorThrown) {\n      let action = jqXHR.getResponseHeader('yf-action');\n      if (action === 'logout') {\n        window.location.href = 'index.php';\n      }\n      if (CONFIG.debug) {\n        if (jqXHR.status === 406) {\n          let sep = '-'.repeat(150);\n          console.warn(\n            '%cYetiForce debug mode!!!',\n            'color: red; font-family: sans-serif; font-size: 1.5em; font-weight: bolder; text-shadow: #000 1px 1px;'\n          );\n          console.error(\n            'Error: ' + errorThrown,\n            '\\n' + sep + '\\nTrace:\\n' + sep + '\\n' + (jqXHR.responseJSON ? jqXHR.responseJSON.error.trace : ''),\n            '\\n' + sep + '\\nParams:\\n' + sep + '\\n' + JSON.stringify(params, null, '\\t')\n          );\n        } else {\n          app.errorLog(jqXHR, textStatus, errorThrown);\n        }\n      }\n      if (textStatus == 'error' && jqXHR.responseJSON) {\n        textStatus = jqXHR.responseJSON.error.message;\n      }\n      aDeferred.reject(textStatus, errorThrown, jqXHR);\n    };\n    if (params.data === '') {\n      app.showNotify({ type: 'error', title: app.vtranslate('JS_ERROR') });\n      return aDeferred.reject();\n    }\n    jQuery.ajax(params);\n    if (pjaxMode) {\n      if (typeof params.data.historyUrl !== 'undefined') {\n        fullUrl = params.data.historyUrl;\n      }\n      if (fullUrl === '') {\n        fullUrl = 'index.php?' + $.param(params.data);\n      } else if (fullUrl.indexOf('index.php?') === -1) {\n        fullUrl = 'index.php?' + fullUrl;\n      }\n      if (app.isWindowTop() && history.pushState && fullUrl !== '') {\n        const currentHref = window.location.href;\n        if (!history.state) {\n          history.replaceState(currentHref, 'title 1', currentHref);\n        }\n        history.pushState(fullUrl, 'title 2', fullUrl);\n      }\n    }\n    return aDeferred.promise();\n  },\n\n  /**\n   * Send form data\n   * @param {string} url\n   * @param {object} postData\n   * @param {object} formAttr\n   */\n  requestForm: function (url, postData = {}, formAttr = {}) {\n    $.extend(formAttr, {\n      method: 'post',\n      action: url,\n      style: 'display:none;',\n    });\n    let form = $('<form></form>', formAttr);\n    if (typeof csrfMagicName !== 'undefined') {\n      postData[csrfMagicName] = csrfMagicToken;\n    }\n    $.each(postData, (index, value) => {\n      let input = $(document.createElement('input'));\n      input.attr('type', 'hidden');\n      input.attr('name', index);\n      input.val(value);\n      form.append(input);\n    });\n    $('body').append(form);\n    form.trigger('submit');\n    form.remove();\n  },\n};\n\n$(function () {\n  $(this).on('click', '.js-post-action', function (e) {\n    e.preventDefault();\n    let element = $(this);\n    if (element.attr('href')) {\n      AppConnector.requestForm(element.attr('href'));\n    }\n  });\n});\n"],"names":["window","AppConnector","requestPjax","params","_request","request","rawData","pjaxMode","aDeferred","jQuery","Deferred","index","callerParams","fullUrl","data","$","extend","indexOf","subStr","substr","replace","type","jsonp","dataType","hasOwnProperty","url","urlSplit","split","queryString","queryParameters","length","queryParam","queryParamComponents","success","error","app","errorLog","message","Vtiger_Helper_Js","showMessage","text","resolve","jqXHR","textStatus","errorThrown","action","getResponseHeader","location","href","CONFIG","debug","status","repeat","console","warn","responseJSON","trace","JSON","stringify","reject","showNotify","title","vtranslate","ajax","historyUrl","param","isWindowTop","history","pushState","currentHref","state","replaceState","promise","requestForm","postData","formAttr","method","style","form","csrfMagicName","csrfMagicToken","each","value","input","document","createElement","attr","val","append","trigger","remove","on","e","preventDefault","element"],"mappings":"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"}
